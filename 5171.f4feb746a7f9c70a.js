"use strict";var je=Object.defineProperty,ke=Object.defineProperties,Ue=Object.getOwnPropertyDescriptors,fe=Object.getOwnPropertySymbols,Ze=Object.prototype.hasOwnProperty,Me=Object.prototype.propertyIsEnumerable,pe=(J,W,y)=>W in J?je(J,W,{enumerable:!0,configurable:!0,writable:!0,value:y}):J[W]=y,re=(J,W)=>{for(var y in W||(W={}))Ze.call(W,y)&&pe(J,y,W[y]);if(fe)for(var y of fe(W))Me.call(W,y)&&pe(J,y,W[y]);return J},le=(J,W)=>ke(J,Ue(W));(self.webpackChunkesri4_pwa=self.webpackChunkesri4_pwa||[]).push([[5171],{90512:(J,W,y)=>{y.d(W,{Z:()=>U});var Q=y(10699);class U{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(E,T,P){this._layerById[T]=P,this._layerByName[E]=P}featureSetByName(E,T=!0,P=["*"]){return this.resolvePromise(void 0===this._layerByName[E]?null:this._layerByName[E])}featureSetById(E,T=!0,P=["*"]){return this.resolvePromise(void 0===this._layerById[E]?null:this._layerById[E])}castToText(){return"object, FeatureSetCollection"}resolvePromise(E){return(0,Q.DB)(E)}}},85171:(J,W,y)=>{y.r(W),y.d(W,{constructAssociationMetaDataFeatureSetFromUrl:()=>Ee,constructFeatureSet:()=>ee,constructFeatureSetFromPortalItem:()=>Ne,constructFeatureSetFromRelationship:()=>Te,constructFeatureSetFromUrl:()=>ae,convertToFeatureSet:()=>Le,createFeatureSetCollectionFromMap:()=>xe,createFeatureSetCollectionFromService:()=>Oe,getPortal:()=>Be,initialiseMetaDataCache:()=>be,lookupUser:()=>Ae});var Q=y(24263),U=y(84792),k=y(90512),E=y(53997),T=y(88879),P=y(47562),w=y(52724),D=y(95896),L=y(49086),_=y(91510),I=y(57366),g=y(77132),C=y(83947),p=y(45333),v=y(10410);class l{clone(){const e=new l;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,s){const i=new l;i.field=e;const d=v.WhereClause.create(t,s),a=function m(b){if("function"===b.parseTree.type){if(0===b.parseTree.args.value.length)return{name:b.parseTree.name,expr:null};if(b.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=v.WhereClause.create((0,C.XF)(b.parseTree.args.value[0],g.Bj.Standardised,b.parameters),b.fieldsIndex);return{name:b.parseTree.name,expr:e}}return null}(d);if(null===a)throw new Error("Invalid Statistic Function");const n=a.name.toUpperCase().trim();if("MIN"===n){if(i.typeofstat="MIN",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===n){if(i.typeofstat="MAX",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===n)i.typeofstat="COUNT",i.workingexpr=a.expr;else if("STDEV"===n){if(i.typeofstat="STDDEV",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===n){if(i.typeofstat="SUM",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===n){if(i.typeofstat="AVG",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===n){if(i.typeofstat="AVG",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==n)throw new Error("Invalid Statistic Function");if(i.typeofstat="VAR",i.workingexpr=a.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}return i}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var u=y(50011),r=y(10699),o=y(65234),h=y(36255),c=y(60466);function F(b){if(!b)return"COUNT";switch(b.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class j extends L.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then(t=>(this._wset=t,this._wset)):(0,r.DB)(this._wset)}_isInFeatureSet(){return g.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,s=1;const i=this._parent?this._parent.getFieldsIndex():new c.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let a=!1;for(let n=0;n<this._config.groupbyfields.length;n++)if(this._config.groupbyfields[n].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}if(!1===a)for(let n=0;n<this._config.statsfields.length;n++)if(this._config.statsfields[n].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}!1===a?t=!0:(this.objectIdField="ROW__ID"+s.toString(),s++)}for(const a of this._config.statsfields){const n=new l;n.field=a.name,n.tofieldname=a.name,n.workingexpr=a.expression instanceof v.WhereClause?a.expression:v.WhereClause.create(a.expression,i),n.typeofstat=F(a.statistic),this._decodedStatsfield.push(n)}this._decodedGroupbyfield=[];for(const a of this._config.groupbyfields){const n={name:a.name,singlefield:null,tofieldname:a.name,expression:a.expression instanceof v.WhereClause?a.expression:v.WhereClause.create(a.expression,i)};this._decodedGroupbyfield.push(n)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const a of this._parent.fields)e[a.name.toUpperCase()]=1;this.types=null}else this.geometryType=g.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new o.Z({wkid:4326});this.fields=[];const d=new l;d.field=this._nextUniqueName(e),d.tofieldname=this.objectIdField,d.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),d.typeofstat="MIN",this._decodedStatsfield.push(d);for(const a of this._decodedGroupbyfield){const n=new h.Z;if(a.name=this._nextUniqueName(e),n.name=a.tofieldname,n.alias=n.name,(0,C.y5)(a.expression)){const f=this._parent.getField((0,C.zR)(a.expression,g.Bj.Standardised));if(!f)throw new Error("Field is not present for Aggregation");a.name=f.name,a.singlefield=f.name,this.phsyicalgroupbyfields.push(f.name),n.type=f.type}else{n.type=this._convertToEsriFieldType((0,C.DT)(a.expression,this._parent.fields));const f=new h.Z;f.name=a.name,f.alias=f.name,this.phsyicalgroupbyfields.push(a.name),this._adaptedFields.push(new w.yN(f,a.expression)),this._candosimplegroupby=!1}this.fields.push(n)}if(this._adaptedFields.length>0)for(const a of this._parent.fields)this._adaptedFields.push(new w.$X(a));for(let a=0;a<this._decodedStatsfield.length;a++){const n=new h.Z;let f=null;const S=this._decodedStatsfield[a];S.field=this._nextUniqueName(e),S.tofieldname===this.objectIdField&&(this._internalObjectIdField=S.field),n.name=S.tofieldname,n.alias=n.name;const R=null!==S.workingexpr&&(0,C.y5)(S.workingexpr)?(0,C.zR)(S.workingexpr,g.Bj.Standardised):"";switch(this._decodedStatsfield[a].typeofstat){case"SUM":if(""!==R){if(f=this._parent.getField(R),!f)throw new Error("Field is not present for Aggregation");n.type=f.type}else n.type="double";break;case"MIN":case"MAX":if(""!==R){if(f=this._parent.getField(R),!f)throw new Error("Field is not present for Aggregation");n.type=f.type}else n.type="double";break;case"COUNT":n.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==R&&(f=this._parent.getField(R),!f))throw new Error("Field is not present for Aggregation");n.type="double"}this.fields.push(n)}}_canDoAggregates(){return(0,r.DB)(!1)}_getFeatures(e,t,s,i){const d=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,d)?this._expandPagedSet(e,d,0,0,i).then(()=>this._getFeatures(e,t,s,i)):(0,r.DB)("success")}_getFilteredSet(e,t,s,i,d){if(""!==e)return(0,r.DB)(new _.Z([],[],!0,null));let a=null;const n={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then(()=>{if(null!==s)for(let f=0;f<this._decodedStatsfield.length;f++)if(!0===(0,C.hq)(s,this._decodedStatsfield[f].tofieldname)){n.nowhereclause=!0,s=null;break}if(null!==i){n.ordered=!0;for(let f=0;f<this._decodedStatsfield.length;f++)if(!0===i.scanForField(this._decodedStatsfield[f].tofieldname)){i=null,n.ordered=!1;break}if(null!==i)for(const f of this._decodedGroupbyfield)if(null===f.singlefield&&!0===i.scanForField(f.tofieldname)){i=null,n.ordered=!1;break}}return!1===this._candosimplegroupby?(0,r.DB)(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)}).then(f=>{if(f){let R=null;s&&(R=this._reformulateWhereClauseWithoutGroupByFields(s));let N=null;return i&&(N=this._reformulateOrderClauseWithoutGroupByFields(i)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,R,N,this._internalObjectIdField).then(O=>(this._checkCancelled(d),a=!0===n.nowhereclause?new _.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],!0===n.ordered&&O._ordered,this._clonePageDefinition(O.pagesDefinition)):new _.Z(O._candidates.slice(0),O._known.slice(0),!0===n.ordered&&O._ordered,this._clonePageDefinition(O.pagesDefinition)),a))}let S=this._parent;if(this._adaptedFields.length>0&&(S=new w.Xx({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===n.nowhereclause)a=new _.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new D.Z({parentfeatureset:S,orderbyclause:new I.Z(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let R=S;if(null!==s){let N=null;s&&(N=this._reformulateWhereClauseWithoutGroupByFields(s)),R=new E.Z({parentfeatureset:R,whereclause:N})}a=new _.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new D.Z({parentfeatureset:R,orderbyclause:new I.Z(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return a})}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,C.bB)(e,t.tofieldname,(0,C.zR)(t.workingexpr,g.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,C.bB)(e,t.tofieldname,(0,C.zR)(t.expression,g.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const s of this._decodedGroupbyfield)s.tofieldname!==s.name&&t.push({field:s.tofieldname,newfield:s.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,s){try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,s).then(()=>this._refineSetBlock(e,t,s)):(this._checkCancelled(s),this._refineKnowns(e,t),(0,r.DB)(e))}catch(i){return(0,r.d1)(i)}}_expandPagedSet(e,t,s,i,d){return this._expandPagedSetFeatureSet(e,t,s,i,d)}_getPhysicalPage(e,t,s){return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?(0,r.Ue)((i,d)=>{this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,s,[]).then(a=>{i(a)},d)}):this._getAgregagtePhysicalPage(e,t,s).then(i=>{for(const d of i){const a={geometry:d.geometry,attributes:{}};for(const n of this._decodedGroupbyfield)a.attributes[n.tofieldname]=d.attributes[n.name];for(const n of this._decodedStatsfield)a.attributes[n.tofieldname]=d.attributes[n.field];this._featureCache[a.attributes[this.objectIdField]]=new T.Z(a)}return i.length})}_sequentialGetPhysicalItem(e,t,s,i){return(0,r.Ue)((d,a)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(s)),!0===e.pagesDefinition.internal.fullyResolved||0===t?d(i.length):this._nextAggregateItem(e,t,s,i,n=>{d(null===n?i.length:this._sequentialGetPhysicalItem(e,t-=1,s,i))},a)})}_nextAggregateItem(e,t,s,i,d,a){try{(0,P.X)(e.pagesDefinition.internal.iterator.next()).then(n=>{if(null===n)if(null!==e.pagesDefinition.internal.workingItem){const f=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);i.push(f),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(f.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,d(null)}else e.pagesDefinition.internal.fullyResolved=!0,d(null);else{const f=this._generateAggregateHash(n);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[n],id:f};else{if(f!==e.pagesDefinition.internal.workingItem.id){const S=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return i.push(S),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(S.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[n],id:f},void d(S)}e.pagesDefinition.internal.workingItem.features.push(n)}this._nextAggregateItem(e,t,s,i,d,a)}},a)}catch(n){a(n)}}_calculateFieldStat(e,t,s){const i=[];for(let d=0;d<e.features.length;d++)if(null!==t.workingexpr){const a=t.workingexpr.calculateValue(e.features[d]);null!==a&&i.push(a)}else i.push(null);switch(t.typeofstat){case"MIN":s.attributes[t.tofieldname]=(0,p.tj)("min",i,-1);break;case"MAX":s.attributes[t.tofieldname]=(0,p.tj)("max",i,-1);break;case"SUM":s.attributes[t.tofieldname]=(0,p.tj)("sum",i,-1);break;case"COUNT":s.attributes[t.tofieldname]=i.length;break;case"VAR":s.attributes[t.tofieldname]=(0,p.tj)("var",i,-1);break;case"STDDEV":s.attributes[t.tofieldname]=(0,p.tj)("stddev",i,-1);break;case"AVG":s.attributes[t.tofieldname]=(0,p.tj)("avg",i,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const i of this._decodedGroupbyfield){const d=i.singlefield?e.features[0].attributes[i.singlefield]:i.expression.calculateValue(e.features[0]);t.attributes[i.tofieldname]=d}for(const i of this._decodedStatsfield)this._calculateFieldStat(e,i,t);const s=[];for(let i=0;i<this._decodedStatsfield.length;i++)s.push(this._calculateFieldStat(e,this._decodedStatsfield[i],t));return this._featureCache[t.attributes[this.objectIdField]]=new T.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const s of this._decodedGroupbyfield){const i=s.singlefield?e.attributes[s.singlefield]:s.expression.calculateValue(e);t+=null==i?":":":"+i.toString()}return(0,u.F)(t,u.M.String)}_stat(){return(0,r.DB)({calculated:!1})}getFeatureByObjectId(){return(0,r.DB)(null)}static registerAction(){L.Z._featuresetFunctions.groupby=function(e,t){return new j({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var A=y(3482),B=y(79429),x=y(22386),q=y(91179),Z=y(15382),te=y(82054),_e=(y(21726),y(16730),y(87183),y(67736),y(90463)),ye=(y(29132),y(20477)),H=y(84952),ge=y(24865),ue=y(2865),me=(y(8314),y(37053),y(17253)),de=y(67010),Fe=(y(13924),y(6871),y(98558)),he=y(60776),Se=y(6729);class se extends L.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return g.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,g.hd)(e.toJSON());return(0,u.F)(t,u.M.String)}load(){return null===this._loadPromise&&(this._loadPromise=(0,r.Ue)((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),e(this)}catch(s){t(s)}},t),this._layer.load()}catch(s){t(s)}})),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const s of this._layer.outFields)if(s.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const s of this.fields)if("oid"===s.type)e.push(s),t.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){e.push(s),t.push(s.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=g.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=g.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=g.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=g.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return g.dj.InFeatureSet}_refineSetBlock(e){return(0,r.DB)(e)}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(t=>(this._wset=t,t)):(0,r.DB)(this._wset)}_runDatabaseProbe(e){return(0,r.Ue)((t,s)=>{try{this._ensureLoaded().then(()=>{try{const i=new H.Z;i.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(i).then(()=>{t(!0)},()=>{try{t(!1)}catch(d){s(d)}})}catch(i){s(i)}})}catch(i){s(i)}})}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){return e.quantizationParameters={mode:"edit"},(0,ye.executeQueryPBF)(this._layer.parsedUrl,e,new Fe.J({})).then(t=>me.default.fromJSON((0,te.cn)(t.data)).unquantize())}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const s="execute"===t?ue.e:"executeForCount"===t?_e.P:ge.G,i="execute"===t&&this.pbfSupportedForQuery(e);let d=null;if(this.recentlyUsedQueries){const a=this.convertQueryToLruCacheKey(e);d=this.recentlyUsedQueries.getFromCache(a),null===d&&(d=!0!==i?s(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(a,d),d=d.catch(n=>{throw this.recentlyUsedQueries.removeFromCache(a),n}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===d&&(d=!0!==i?s(this._layer.parsedUrl.path,e):this.queryPBF(e)),d}_getFilteredSet(e,t,s,i,d){return this.databaseType().then(a=>{if(this.isTable()&&t&&null!==e&&""!==e)return new _.Z([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,s,i,d);let n="",f=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(n=i.constructClause(),f=!0);const S=new H.Z;return S.where=null===s?null===t?"1=1":"":(0,C.zR)(s,a),this._requestStandardised&&(S.sqlFormat="standard"),S.spatialRelationship=this._makeRelationshipEnum(e),S.outSpatialReference=this.spatialReference,S.orderByFields=""!==n?n.split(","):null,S.geometry=null===t?null:t,S.relationParameter=this._makeRelationshipParam(e),this.executeQuery(S,"executeForIds").then(R=>(null===R&&(R=[]),this._checkCancelled(d),new _.Z([],R,f,null)))})}_expandPagedSet(e,t,s,i,d){return this._expandPagedSetFeatureSet(e,t,s,i,d)}_getFilteredSetUsingPaging(e,t,s,i,d){try{let a="",n=!1;return null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(a=i.constructClause(),n=!0),this.databaseType().then(f=>{let S=null===s?null===t?"1=1":"":(0,C.zR)(s,f);this._layer.definitionExpression&&this._useDefinitionExpression&&(S=""!==S?"(("+this._layer.definitionExpression+") AND ("+S+"))":this._layer.definitionExpression);let R=this._maxQueryRate();const N=this._layer.capabilities.query.maxRecordCount;void 0!==N&&N<R&&(R=N);let O=null;if(!0===this._pageJustIds)O=new _.Z([],["GETPAGES"],n,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:R,resultOffset:0,geometry:null===t?null:t,where:S,orderByFields:a,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let V=!0;!0===this._removeGeometry&&(V=!1);const G=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);O=new _.Z([],["GETPAGES"],n,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:G.join(","),resultRecordCount:R,resultOffset:0,geometry:null===t?null:t,where:S,orderByFields:a,returnGeometry:V,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(O,R,0,1,d).then(()=>O)})}catch(a){return(0,r.d1)(a)}}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,s){try{const i=e.pagesDefinition.internal.lastRetrieved,d=i,a=e.pagesDefinition.internal.lastPage,n=new H.Z;return this._requestStandardised&&(n.sqlFormat="standard"),n.spatialRelationship=e.pagesDefinition.spatialRel,n.relationParameter=e.pagesDefinition.relationParam,n.outFields=e.pagesDefinition.outFields.split(","),n.num=e.pagesDefinition.resultRecordCount,n.start=e.pagesDefinition.internal.lastPage,n.geometry=e.pagesDefinition.geometry,n.where=e.pagesDefinition.where,n.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,n.returnGeometry=e.pagesDefinition.returnGeometry,n.outSpatialReference=this.spatialReference,this.executeQuery(n,"execute").then(f=>{if(this._checkCancelled(s),e.pagesDefinition.internal.lastPage!==a)return"done";for(let S=0;S<f.features.length;S++)e.pagesDefinition.internal.set[d+S]=f.features[S].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let S=0;S<f.features.length;S++)this._featureCache[f.features[S].attributes[this._layer.objectIdField]]=f.features[S];return(void 0===f.exceededTransferLimit&&f.features.length!==e.pagesDefinition.resultRecordCount||!1===f.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+f.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})}catch(i){return(0,r.d1)(i)}}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let s=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&t.push(this.objectIdField),t}_getFeatures(e,t,s,i){const d=[];try{if(-1!==t&&void 0===this._featureCache[t]&&d.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,i).then(()=>this._getFeatures(e,t,s,i));let a=0;for(let n=e._lastFetchedIndex;n<e._known.length;n++){if(e._lastFetchedIndex+=1,a++,void 0===this._featureCache[e._known[n]]){let f=!1;if(null!=this._layer._mode){const S=this._layer._mode;if(void 0!==S._featureMap[e._known[n]]){const R=S._featureMap[e._known[n]];null!==R&&(f=!0,this._featureCache[e._known[n]]=R)}}if(!1===f&&(e._known[n]!==t&&d.push(e._known[n]),d.length>=this._maxProcessingRate()-1))break}if(a>=s&&0===d.length)break}if(0===d.length)return(0,r.DB)("success");try{const n=new H.Z;return this._requestStandardised&&(n.sqlFormat="standard"),n.objectIds=d,n.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),n.returnGeometry=!0,!0===this._removeGeometry&&(n.returnGeometry=!1),n.outSpatialReference=this.spatialReference,this.executeQuery(n,"execute").then(f=>{if(this._checkCancelled(i),void 0!==f.error)return(0,r.d1)(new Error(f.error));for(let S=0;S<f.features.length;S++)this._featureCache[f.features[S].attributes[this._layer.objectIdField]]=f.features[S];return"success"})}catch(n){return(0,r.d1)(n)}}catch(a){return(0,r.d1)(a)}}_getDistinctPages(e,t,s,i,d,a,n,f,S){return this._ensureLoaded().then(()=>this.databaseType()).then(R=>{let N=s.parseTree.column;for(let G=0;G<this._layer.fields.length;G++)if(this._layer.fields[G].name.toLowerCase()===N.toLowerCase()){N=this._layer.fields[G].name;break}const O=new H.Z;this._requestStandardised&&(O.sqlFormat="standard");let V=null===a?null===d?"1=1":"":(0,C.zR)(a,R);return this._layer.definitionExpression&&this._useDefinitionExpression&&(V=""!==V?"(("+this._layer.definitionExpression+") AND ("+V+"))":this._layer.definitionExpression),O.where=V,O.spatialRelationship=this._makeRelationshipEnum(i),O.relationParameter=this._makeRelationshipParam(i),O.geometry=null===d?null:d,O.returnDistinctValues=!0,O.returnGeometry=!1,O.outFields=[N],this.executeQuery(O,"execute").then(G=>{if(this._checkCancelled(S),!G.hasOwnProperty("features"))return(0,r.d1)(new Error("Unnexected Result querying statistics from layer"));let X=!1;for(let M=0;M<this._layer.fields.length;M++)if(this._layer.fields[M].name===N){"date"===this._layer.fields[M].type&&(X=!0);break}for(let M=0;M<G.features.length;M++){if(X){const z=G.features[M].attributes[N];f.push(null!==z?new Date(z):z)}else f.push(G.features[M].attributes[N]);if(f.length>=n)break}return 0===G.features.length?f:G.features.length===this._layer.capabilities.query.maxRecordCount&&f.length<n?this._getDistinctPages(e+G.features.length,t,s,i,d,a,n,f,S).then(M=>({calculated:!0,result:M})):f})})}_distinctStat(e,t,s,i,d,a,n){return this._getDistinctPages(0,e,t,s,i,d,a,[],n).then(f=>({calculated:!0,result:f}))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,s,i){return this.databaseType().then(d=>{const a=new H.Z;if(this._requestStandardised&&(a.sqlFormat="standard"),this.isTable()&&s&&null!==t&&""!==t)return{calculated:!0,result:0};let n=null===i?null===s?"1=1":"":(0,C.zR)(i,d);return this._layer.definitionExpression&&this._useDefinitionExpression&&(n=""!==n?"(("+this._layer.definitionExpression+") AND ("+n+"))":this._layer.definitionExpression),a.where=n,a.where=n,a.spatialRelationship=this._makeRelationshipEnum(t),a.relationParameter=this._makeRelationshipParam(t),a.geometry=null===s?null:s,a.returnGeometry=!1,this.executeQuery(a,"executeForCount").then(f=>({calculated:!0,result:f}))})}_stats(e,t,s,i,d,a,n){return this._ensureLoaded().then(()=>{const f=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,S=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,R=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?R?this._countstat(e,s,i,d):{calculated:!1}:!1===S||!1===(0,C.y5)(t)&&!1===f||!1===t.isStandardized?""!==s||null!==d?{calculated:!1}:this._manualStat(e,t,a,n):"distinct"===e?!1===R?""!==s||null!==d?{calculated:!1}:this._manualStat(e,t,a,n):this._distinctStat(e,t,s,i,d,a,n):this.databaseType().then(N=>{if(this.isTable()&&i&&null!==s&&""!==s)return{calculated:!0,result:null};const O=new H.Z;this._requestStandardised&&(O.sqlFormat="standard");let V=null===d?null===i?"1=1":"":(0,C.zR)(d,N);this._layer.definitionExpression&&this._useDefinitionExpression&&(V=""!==V?"(("+this._layer.definitionExpression+") AND ("+V+"))":this._layer.definitionExpression),O.where=V,O.spatialRelationship=this._makeRelationshipEnum(s),O.relationParameter=this._makeRelationshipParam(s),O.geometry=null===i?null:i;const G=new he.Z;G.statisticType=(0,p.g3)(e),G.onStatisticField=(0,C.zR)(t,N),G.outStatisticFieldName="ARCADE_STAT_RESULT",O.returnGeometry=!1;let X="ARCADE_STAT_RESULT";return O.outStatistics=[G],this.executeQuery(O,"execute").then(M=>{if(!M.hasOwnProperty("features")||0===M.features.length)return(0,r.d1)(new Error("Unnexected Result querying statistics from layer"));let z=!1;for(let Y=0;Y<M.fields.length;Y++)if("ARCADE_STAT_RESULT"===M.fields[Y].name.toUpperCase()){X=M.fields[Y].name,"date"===M.fields[Y].type&&(z=!0);break}if(z){let Y=M.features[0].attributes[X];return null!==Y&&(Y=new Date(M.features[0].attributes[X])),{calculated:!0,result:Y}}return{calculated:!0,result:M.features[0].attributes[X]}})})})}_stat(e,t,s,i,d,a,n){return this._stats(e,t,s,i,d,a,n)}_canDoAggregates(e,t){return this._ensureLoaded().then(()=>{let s=!1;const i=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=!0),s)for(let d=0;d<t.length-1;d++)null!==t[d].workingexpr&&(!1===t[d].workingexpr.isStandardized||!1===(0,C.y5)(t[d].workingexpr)&&!1===i)&&(s=!1);return!1!==s})}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,s,i,d,a,n){return this._ensureLoaded().then(()=>this.databaseType()).then(f=>{let S="",R=!1,N=!1;null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(S=a.constructClause(),N=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(N=!1,R=!0,S=this._layer.objectIdField);const O=[];for(let M=0;M<t.length;M++){const z=new he.Z;z.onStatisticField=null!==t[M].workingexpr?(0,C.zR)(t[M].workingexpr,f):"",z.outStatisticFieldName=t[M].field,z.statisticType=t[M].toStatisticsName(),O.push(z)}""===S&&(S=e.join(","));let V=this._maxQueryRate();const G=this._layer.capabilities.query.maxRecordCount;void 0!==G&&G<V&&(V=G);let X=null===d?null===i?"1=1":"":(0,C.zR)(d,f);return this._layer.definitionExpression&&this._useDefinitionExpression&&(X=""!==X?"(("+this._layer.definitionExpression+") AND ("+X+"))":this._layer.definitionExpression),new _.Z([],["GETPAGES"],N,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:R,generatedOid:n,resultRecordCount:V,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:O,geometry:null===i?null:i,where:X,orderByFields:S,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})}_getAgregagtePhysicalPage(e,t,s){try{let i=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(i=""!==i?"("+i+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const d=e.pagesDefinition.internal.lastRetrieved,a=d,n=e.pagesDefinition.internal.lastPage,f=new H.Z;return this._requestStandardised&&(f.sqlFormat="standard"),f.where=i,f.spatialRelationship=e.pagesDefinition.spatialRel,f.relationParameter=e.pagesDefinition.relationParam,f.outFields=e.pagesDefinition.outFields,f.outStatistics=e.pagesDefinition.outStatistics,f.geometry=e.pagesDefinition.geometry,f.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,f.num=e.pagesDefinition.resultRecordCount,f.start=e.pagesDefinition.internal.lastPage,f.returnGeometry=e.pagesDefinition.returnGeometry,f.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&f.geometry&&f.spatialRelationship?(0,r.DB)([]):this.executeQuery(f,"execute").then(S=>{if(this._checkCancelled(s),!S.hasOwnProperty("features"))return(0,r.d1)(new Error("Unnexected Result querying aggregates from layer"));const R=[];if(e.pagesDefinition.internal.lastPage!==n)return[];for(let N=0;N<S.features.length;N++)e.pagesDefinition.internal.set[a+N]=S.features[N].attributes[e.pagesDefinition.generatedOid];for(let N=0;N<S.features.length;N++)R.push(new T.Z({attributes:S.features[N].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===S.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=S.features[S.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===S.exceededTransferLimit&&S.features.length!==e.pagesDefinition.resultRecordCount||!1===S.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=d+S.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,R})}catch(i){return(0,r.d1)(i)}}static create(e,t,s,i,d){const a=new Z.default({url:e,outFields:null===t?["*"]:t});return new se({layer:a,spatialReference:s,lrucache:i,interceptor:d})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,g.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,s,i,d){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const a={objectIds:[e],returnMetadata:d};return(t&&t>0||s&&s>0)&&(a.size=[t&&t>0?t:0,s&&s>0?s:t+1]),i&&i.length>0&&(a.attachmentTypes=i),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:"attachments"}),this._layer.queryAttachments(a).then(n=>{const f=[];return n&&n[e]&&n[e].forEach(S=>{const R=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+S.id.toString();let N=null;d&&S.exifInfo&&(N=Se.Z.convertJsonToArcade(S.exifInfo,!0)),f.push(new x.Z(S.id,S.name,S.contentType,S.size,R,N))}),f})}return(0,r.DB)([])}queryRelatedFeatures(e){const t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return null!=e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),(0,U.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then(s=>{if(s.data){const i={},d=s.data;if(d&&d.relatedRecordGroups){const a=d.spatialReference;for(const n of d.relatedRecordGroups){const f=n.objectId,S=[];for(const R of n.relatedRecords){R.geometry&&(R.geometry.spatialReference=a);const N=new T.Z({geometry:R.geometry?(0,q.im)(R.geometry):null,attributes:R.attributes});S.push(N)}i[f]={features:S,exceededTransferLimit:!0===d.exceededTransferLimit}}}return i}return(0,r.d1)("Invalid Request")})}getFeatureByObjectId(e,t){const s=new H.Z;return s.outFields=t,s.returnGeometry=!1,s.outSpatialReference=this.spatialReference,s.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:s,method:"execute"}),(0,ue.e)(this._layer.parsedUrl.path,s).then(i=>1===i.features.length?i.features[0]:null)}getIdentityUser(){return this.load().then(()=>{var e;const t=null==(e=Q.id)?void 0:e.findCredential(this._layer.url);return t?t.userId:null})}getOwningSystemUrl(){return this.load().then(()=>{var e;const t=null==(e=Q.id)?void 0:e.findServerInfo(this._layer.url);if(t)return(0,r.DB)(t.owningSystemUrl);let s=this._layer.url;const i=s.toLowerCase().indexOf("/rest/services");return s=i>-1?s.substring(0,i):s,s?(s+="/rest/info",(0,r.Ue)((d,a)=>{(0,U.default)(s,{query:{f:"json"}}).then(n=>{let f="";n.data&&n.data.owningSystemUrl&&(f=n.data.owningSystemUrl),d(f)},n=>{d("")})})):(0,r.DB)("")})}getDataSourceFeatureSet(){const e=new se({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}var Ie=y(16776);class we extends L.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return g.tI}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,r.Ue)((e,t)=>{(0,r.$6)([this._layer.load(),this.relatedLayer.load()]).then(()=>{this._initialiseFeatureSet(),e(this)},t)})),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],s=[];for(const i of this.fields)if("oid"===i.type)t.push(i),s.push(i.name);else for(const d of this._overrideFields)if(d.toLowerCase()===i.name.toLowerCase()){t.push(i),s.push(i.name);break}this.fields=t,this._overrideFields=s}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then(()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return g.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(t=>(this._wset=t,t)):(0,r.DB)(this._wset)}_changeFeature(e){const t={};for(const s of this.fields)t[s.name]=e.attributes[s.name];return new T.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,s,i,d){return this.databaseType().then(()=>{if(this.isTable()&&t&&null!==e&&""!==e)return new _.Z([],[],!0,null);const a=this._layer.nativeCapabilities();if(!1===a.canQueryRelated)return new _.Z([],[],!0,null);if(a.capabilities.queryRelated&&a.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,s,i,d);let n="",f=!1;null!==i&&a.capabilities&&a.capabilities.queryRelated&&!0===a.capabilities.queryRelated.supportsOrderBy&&(n=i.constructClause(),f=!0);const S=new de.Z;S.objectIds=[this._findObjectId];const R=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(O=>O.name):["*"]);S.outFields=R,S.relationshipId=this.relationship.id,S.where="1=1";let N=!0;return!0===this._removeGeometry&&(N=!1),S.returnGeometry=N,this._requestStandardised&&(S.sqlFormat="standard"),S.outSpatialReference=this.spatialReference,S.orderByFields=""!==n?n.split(","):null,a.source.queryRelatedFeatures(S).then(O=>{this._checkCancelled(d);const V=O[this._findObjectId]?O[this._findObjectId].features:[],G=[];for(let z=0;z<V.length;z++)this._featureCache[V[z].attributes[this.relatedLayer.objectIdField]]=V[z],G.push(V[z].attributes[this.relatedLayer.objectIdField]);const X=t&&null!==e&&""!==e,M=null!=s;return new _.Z(X||M?G:[],X||M?[]:G,f,null)})})}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let s=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,s,i,d){try{let a="",n=!1;const f=this._layer.nativeCapabilities();return null!==i&&f&&f.capabilities.queryRelated&&!0===f.capabilities.queryRelated.supportsOrderBy&&(a=i.constructClause(),n=!0),this.databaseType().then(()=>{let R=this._maxQueryRate();const N=f.capabilities.query.maxRecordCount;void 0!==N&&N<R&&(R=N);const O=t&&null!==e&&""!==e,V=null!=s;let G=null,X=!0;!0===this._removeGeometry&&(X=!1);const M=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(z=>z.name):["*"]);return G=new _.Z(O||V?["GETPAGES"]:[],O||V?[]:["GETPAGES"],n,{outFields:M.join(","),resultRecordCount:R,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:a,returnGeometry:X,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(G,R,0,0,d).then(()=>G)})}catch(a){return(0,r.d1)(a)}}_expandPagedSet(e,t,s,i,d){return this._expandPagedSetFeatureSet(e,t,s,i,d)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,s){try{const i=e.pagesDefinition.internal.lastRetrieved,d=i,a=e.pagesDefinition.internal.lastPage,n=this._layer.nativeCapabilities(),f=new de.Z;return!0===this._requestStandardised&&(f.sqlFormat="standard"),f.relationshipId=this.relationship.id,f.objectIds=e.pagesDefinition.objectIds,f.resultOffset=e.pagesDefinition.internal.lastPage,f.resultRecordCount=e.pagesDefinition.resultRecordCount,f.outFields=e.pagesDefinition.outFields.split(","),f.where=e.pagesDefinition.where,f.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,f.returnGeometry=e.pagesDefinition.returnGeometry,f.outSpatialReference=this.spatialReference,n.source.queryRelatedFeatures(f).then(S=>{if(this._checkCancelled(s),e.pagesDefinition.internal.lastPage!==a)return 0;const R=S[this._findObjectId]?S[this._findObjectId].features:[];for(let O=0;O<R.length;O++)e.pagesDefinition.internal.set[d+O]=R[O].attributes[this.relatedLayer.objectIdField];for(let O=0;O<R.length;O++)this._featureCache[R[O].attributes[this.relatedLayer.objectIdField]]=R[O];return R.length!==e.pagesDefinition.resultRecordCount&&(!S[this._findObjectId]||!1===S[this._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+R.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,R.length})}catch(i){return(0,r.d1)(i)}}_getFeatures(e,t,s,i){const d=[];-1!==t&&void 0===this._featureCache[t]&&d.push(t);const a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return this._expandPagedSet(e,a,0,0,i).then(()=>this._getFeatures(e,t,s,i));let n=0;for(let f=e._lastFetchedIndex;f<e._known.length&&(n++,n<=s&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[f]&&void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&d.push(e._known[f]),d.length>s)))&&!(n>=s&&0===d.length);f++);return 0===d.length?(0,r.DB)("success"):(0,r.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,t,s){return(0,r.DB)(e)}_stat(e,t,s,i,d,a,n){return(0,r.DB)({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,s,i,d){return(0,r.DB)(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,s,i,d){return this.relatedLayer.queryAttachments(e,t,s,i,d)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}var K=y(53791),De=y(84687),ve=y(55463);function be(){null===K.Z.applicationCache&&(K.Z.applicationCache=new K.Z)}function ie(b,e){if(K.Z.applicationCache){const t=K.Z.applicationCache.getLayerInfo(b);if(t)return t.then(d=>(0,r.DB)(new Z.default({url:b,outFields:e,sourceJSON:d})));const s=new Z.default({url:b,outFields:e});let i=(0,r.Ue)((d,a)=>{s.load().then(()=>{d(s.sourceJSON)},n=>{a(n)})});return K.Z.applicationCache&&(K.Z.applicationCache.setLayerInfo(b,i),i=i.catch(d=>{throw K.Z.applicationCache.clearLayerInfo(b),d})),i.then(()=>(0,r.DB)(s))}return(0,r.DB)(new Z.default({url:b,outFields:e}))}function ae(b,e,t,s,i,d=null){return ie(b,["*"]).then(a=>(0,r.DB)(ee(a,e,t,s,i,d)))}function ee(b,e=null,t=null,s=!0,i=null,d=null){return!0===b._hasMemorySource()?new Ie.Z({layer:b,spatialReference:e,outFields:t,includeGeometry:s,lrucache:i,interceptor:d}):new se({layer:b,spatialReference:e,outFields:t,includeGeometry:s,lrucache:i,interceptor:d})}function ce(b){if(null!==K.Z.applicationCache){const t=K.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}let e=(0,U.default)(b,{responseType:"json",query:{f:"json"}}).then(t=>{if(t.data){const s=t.data;return s.layers||(s.layers=[]),s.tables||(s.tables=[]),(0,r.DB)(s)}return(0,r.DB)({layers:[],tables:[]})});return null!==K.Z.applicationCache&&(K.Z.applicationCache.setLayerInfo(b,e),e=e.catch(t=>{throw K.Z.applicationCache.clearLayerInfo(b),t})),e}function Ee(b,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return ce(b).then(s=>{if(t.metadata=s,s.controllerDatasetLayers&&null!=s.controllerDatasetLayers.utilityNetworkLayerId){if(s.layers)for(const d of s.layers)t.layerNameLkp[d.id]=d.name;if(s.tables)for(const d of s.tables)t.layerNameLkp[d.id]=d.name;const i=s.controllerDatasetLayers.utilityNetworkLayerId;return t.networkId=i,function Re(b,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+b;if(null!==K.Z.applicationCache){const i=K.Z.applicationCache.getLayerInfo(t);if(null!==i)return i}let s=(0,U.default)(b+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}}).then(i=>{if(i.data){const d=i.data;if(d.layerDataElements&&d.layerDataElements[0])return d.layerDataElements[0]}throw new Error("Not Found")});return null!==K.Z.applicationCache&&(K.Z.applicationCache.setLayerInfo(t,s),s=s.catch(i=>{throw K.Z.applicationCache.clearLayerInfo(t),i})),s}(b,i).then(d=>{if(d){t.queryelem=d,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const a of t.queryelem.dataElement.domainNetworks){for(const n of a.edgeSources?a.edgeSources:[]){const f={layerId:n.layerId,sourceId:n.sourceId,className:t.layerNameLkp[n.layerId]?t.layerNameLkp[n.layerId]:null};f.className&&(t.lkp[f.className]=f)}for(const n of a.junctionSources?a.junctionSources:[]){const f={layerId:n.layerId,sourceId:n.sourceId,className:t.layerNameLkp[n.layerId]?t.layerNameLkp[n.layerId]:null};f.className&&(t.lkp[f.className]=f)}}if(t.queryelem.dataElement.terminalConfigurations)for(const a of t.queryelem.dataElement.terminalConfigurations)for(const n of a.terminals)t.terminals.push({terminalId:n.terminalId,terminalName:n.terminalName});return function Ce(b){if(null!==K.Z.applicationCache){const t=K.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}let e=(0,U.default)(b,{responseType:"json",query:{f:"json"}}).then(t=>(0,r.DB)(t.data?t.data:null));return null!==K.Z.applicationCache&&(K.Z.applicationCache.setLayerInfo(b,e),e=e.catch(t=>{throw K.Z.applicationCache.clearLayerInfo(b),t})),e}(b+"/"+i).then(a=>{if(a.systemLayers&&null!=a.systemLayers.associationsTableId){const n=[];return t.unVersion>=4&&(n.push("STATUS"),n.push("PERCENTALONG")),ae(b+"/"+a.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...n],!1,null,null).then(f=>f.load()).then(f=>t.unVersion>=4?(f=f.filter(v.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",f.getFieldsIndex()))).load():f).then(f=>({lkp:t.lkp,associations:f,unVersion:t.unVersion,terminals:t.terminals}))}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}function Te(b,e,t,s=null,i=null,d=!0,a=null,n=null){let f=b.serviceUrl();return f?(f="/"===f.charAt(f.length-1)?f+e.relatedTableId.toString():f+"/"+e.relatedTableId.toString(),ae(f,s,i,d,a,n).then(S=>new we({layer:b,relatedLayer:S,relationship:e,objectId:t,spatialReference:s,outFields:i,includeGeometry:d,lrucache:a,interceptor:n}))):null}E.Z.registerAction(),j.registerAction(),D.Z.registerAction(),A.Z.registerAction(),B.Z.registerAction();class Pe extends k.Z{constructor(e,t=null,s=null,i=null){super(),this._map=e,this._overridespref=t,this.lrucache=s,this.interceptor=i,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,s=null){const i=ee(e,this._overridespref,null===s?["*"]:s,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:i,opitem:e,includeGeometry:t,outFields:JSON.stringify(s)}),i}featureSetByName(e,t=!0,s=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetByName(e,t,s)}catch(a){return(0,r.d1)(a)}});null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let a=0;a<this._instantLayers.length;a++){const n=this._instantLayers[a];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===i)return this.resolvePromise(this._instantLayers[a].featureset)}const d=this._map.allLayers.find(a=>a instanceof Z.default&&a.title===e);if(d)return this.resolvePromise(this._makeAndAddFeatureSet(d,t,s));if(this._map.tables){const a=this._map.tables.find(n=>!!(n.title&&n.title===e||n.title&&n.title===e));if(a){if(a instanceof Z.default)return this.resolvePromise(this._makeAndAddFeatureSet(a,t,s));if(!a._materializedTable){const n=a.outFields?a:le(re({},a),{outFields:["*"]});a._materializedTable=new Z.default(n)}return a._materializedTable.load().then(()=>this.resolvePromise(this._makeAndAddFeatureSet(a._materializedTable,t,s)))}}return this.resolvePromise(null)}featureSetById(e,t=!0,s=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetById(e,t,s)}catch(a){return(0,r.d1)(a)}});null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let a=0;a<this._instantLayers.length;a++){const n=this._instantLayers[a];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===i)return this.resolvePromise(this._instantLayers[a].featureset)}const d=this._map.allLayers.find(a=>a instanceof Z.default&&a.id===e);if(d)return this.resolvePromise(this._makeAndAddFeatureSet(d,t,s));if(this._map.tables){const a=this._map.tables.find(n=>n.id===e);if(a){if(a instanceof Z.default)return this.resolvePromise(this._makeAndAddFeatureSet(a,t,s));if(!a._materializedTable){const n=le(re({},a),{outFields:["*"]});a._materializedTable=new Z.default(n)}return a._materializedTable.load().then(()=>this.resolvePromise(this._makeAndAddFeatureSet(a._materializedTable,t,s)))}}return this.resolvePromise(null)}}class ne extends k.Z{constructor(e,t=null,s=null,i=null){super(),this._url=e,this._overridespref=t,this.lrucache=s,this.interceptor=i,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,s=null){const i=ee(e,this._overridespref,null===s?["*"]:s,t,this.lrucache);return this._instantLayers.push({featureset:i,opitem:e,includeGeometry:t,outFields:JSON.stringify(s)}),i}_loadMetaData(){return ce(this._url).then(e=>(this.metadata=e,e))}load(){return this._loadMetaData()}clone(){return new ne(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,s=null){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let d=0;d<this._instantLayers.length;d++){const a=this._instantLayers[d];if(a.opitem.title===e&&a.includeGeometry===t&&a.outFields===i)return this.resolvePromise(this._instantLayers[d].featureset)}return this._loadMetaData().then(d=>{let a=null;for(const n of d.layers?d.layers:[])n.name===e&&(a=n);if(!a)for(const n of d.tables?d.tables:[])n.name===e&&(a=n);return a?ie(this._url+"/"+a.id,["*"]).then(n=>this._makeAndAddFeatureSet(n,t,s)):this.resolvePromise(null)})}featureSetById(e,t=!0,s=["*"]){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);e=null!=e?e.toString():"";for(let d=0;d<this._instantLayers.length;d++){const a=this._instantLayers[d];if(a.opitem.id===e&&a.includeGeometry===t&&a.outFields===i)return this.resolvePromise(this._instantLayers[d].featureset)}return this._loadMetaData().then(d=>{let a=null;for(const n of d.layers?d.layers:[])null!=n.id&&n.id.toString()===e&&(a=n);if(!a)for(const n of d.tables?d.tables:[])null!=n.id&&n.id.toString()===e&&(a=n);return a?ie(this._url+"/"+a.id,["*"]).then(n=>this._makeAndAddFeatureSet(n,t,s)):this.resolvePromise(null)})}}function xe(b,e,t=null,s=null){return new Pe(b,e,t,s)}function Oe(b,e,t=null,s=null){return new ne(b,e,t,s)}function Be(b,e){return null===b?e:new De.Z({url:b.field("url")})}function Ae(b,e,t){return Q.id.findCredential(b.restUrl)?"loaded"===b.loadStatus&&""===e&&b.user&&b.user.sourceJSON&&!1===t?(0,r.DB)(b.user.sourceJSON):""===e?(0,U.default)(b.restUrl+"/community/self",{responseType:"json",query:re({f:"json"},!1===t?{}:{returnUserLicenseTypeExtensions:!0})}).then(s=>{if(s.data){const i=s.data;if(i&&i.username)return(0,r.DB)(i)}return(0,r.DB)(null)}):(0,U.default)(b.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}}).then(s=>{if(s.data){const i=s.data;return i.error?null:(0,r.DB)(i)}return(0,r.DB)(null)}):(0,r.DB)(null)}function Le(b,e,t,s,i){if(null===b)return null;if(b instanceof Z.default){switch(e){case"datasource":return ee(b,i,b.outFields,!0,t,s).getDataSourceFeatureSet();case"parent":case"root":return ee(b,i,b.outFields,!0,t,s)}return null}if(b instanceof L.Z)switch(e){case"datasource":return b.getDataSourceFeatureSet();case"parent":return b;case"root":return b.getRootFeatureSet()}return null}function Ne(b,e,t,s,i,d,a,n=null){if(K.Z.applicationCache){const f=K.Z.applicationCache.getLayerInfo(b+":"+d.url);if(f)return f.then(S=>{try{const R=new Z.default({url:(0,g.US)(S.url)+"/"+e,outFields:["*"]});return(0,r.DB)(ee(R,t,s,i,a,n))}catch(R){return(0,r.d1)(R)}},S=>(0,r.d1)(S))}return(0,r.Ue)((f,S)=>{const R=new ve.default({id:b,portal:d}).load();K.Z.applicationCache&&K.Z.applicationCache.setLayerInfo(b+":"+d.url,R),R.then(N=>{try{const O=new Z.default({url:(0,g.US)(N.url)+"/"+e,outFields:["*"]});f(ee(O,t,s,i,a,n))}catch(O){S(O)}},N=>{K.Z.applicationCache&&K.Z.applicationCache.clearLayerInfo(b+":"+d.url),S(N)})})}},52724:(J,W,y)=>{y.d(W,{Xx:()=>v,QP:()=>g,$X:()=>I,yN:()=>p,TO:()=>C});var Q=y(88879),U=y(27187),k=y(49086),E=y(91510),T=y(77132),P=y(83947),w=y(10699),D=y(10410),L=y(65234);class _{constructor(l){this.field=l,this.sqlRewritable=!1}postInitialization(l,u){}}class I extends _{constructor(l){super(l),this.sqlRewritable=!0}extractValue(l){return l.attributes[this.field.name]}rewriteSql(l){return{rewritten:this.sqlRewritable,where:l}}}class g extends _{constructor(l,u,r){super((0,T.JW)(l)),this.originalField=l,this.sqlRewritable=!0,this.field.name=u,this.field.alias=r}rewriteSql(l,u){return{rewritten:this.sqlRewritable,where:(0,P.bB)(l,this.field.name,this.originalField.name,u.getFieldsIndex())}}extractValue(l){return l.attributes[this.originalField.name]}}let C=(()=>{class m extends _{constructor(u,r,o){super(u),this.codefield=r,this.lkp=o,this.reverseLkp={};for(const h in o)this.reverseLkp[o[h]]=h;this.sqlRewritable=!0}rewriteSql(u,r){const o=this.evaluateNodeToWhereClause(u.parseTree,T.Bj.Standardised,this.field.name,this.codefield instanceof D.WhereClause?(0,P.zR)(this.codefield,T.Bj.Standardised):this.codefield,u.parameters);return o.indexOf(m.BADNESS)>=0?{rewritten:!1,where:u}:{rewritten:this.sqlRewritable,where:D.WhereClause.create(o,r._parent.getFieldsIndex())}}evaluateNodeToWhereClause(u,r,o=null,h=null,c){let F,j,A,B;switch(u.type){case"interval":return(0,P.TE)(this.evaluateNodeToWhereClause(u.value,r,o,h,c),u.qualifier,u.op);case"case_expression":{let x=" CASE ";"simple"===u.format&&(x+=this.evaluateNodeToWhereClause(u.operand,r,o,m.BADNESS,c));for(let q=0;q<u.clauses.length;q++)x+=" WHEN "+this.evaluateNodeToWhereClause(u.clauses[q].operand,r,o,m.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(u.clauses[q].value,r,o,m.BADNESS,c);return null!==u.else&&(x+=" ELSE "+this.evaluateNodeToWhereClause(u.else,r,o,m.BADNESS,c)),x+=" END ",x}case"param":{const x=c[u.value.toLowerCase()];if("string"==typeof x)return"'"+c[u.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(x instanceof Date)return(0,P.oX)(x,r);if(x instanceof Array){const q=[];for(let Z=0;Z<x.length;Z++)"string"==typeof x[Z]?q.push("'"+x[Z].toString().replace(/'/g,"''")+"'"):x[Z]instanceof Date?q.push((0,P.oX)(x[Z],r)):q.push(x[Z].toString());return q}return x.toString()}case"expr_list":j=[];for(const x of u.value)j.push(this.evaluateNodeToWhereClause(x,r,o,h,c));return j;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(u.expr,r,o,m.BADNESS,c)+" ) ";case"binary_expr":switch(u.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" AND "+this.evaluateNodeToWhereClause(u.right,r,o,h,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" OR "+this.evaluateNodeToWhereClause(u.right,r,o,h,c)+") ";case"IS":if("null"!==u.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IS NULL )";case"ISNOT":if("null"!==u.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IS NOT NULL )";case"IN":if(F=[],"expr_list"===u.right.type){if("column_ref"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let q=!0;for(const Z of u.right.value){if("string"!==Z.type){q=!1;break}if(void 0===this.lkp[Z.value]){q=!1;break}x.push(this.lkp[Z.value].toString())}if(q)return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+x.join(",")+")) "}return F=this.evaluateNodeToWhereClause(u.right,r,o,h,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+F.join(",")+")) "}return B=this.evaluateNodeToWhereClause(u.right,r,o,h,c),B instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+B+")) ";case"NOT IN":if(F=[],"expr_list"===u.right.type){if("column_ref"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let q=!0;for(const Z of u.right.value){if("string"!==Z.type){q=!1;break}if(void 0===this.lkp[Z.value]){q=!1;break}x.push(this.lkp[Z.value].toString())}if(q)return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+x.join(",")+")) "}return F=this.evaluateNodeToWhereClause(u.right,r,o,h,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+F.join(",")+")) "}return B=this.evaluateNodeToWhereClause(u.right,r,o,h,c),B instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+B+")) ";case"BETWEEN":return A=this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" BETWEEN "+A[0]+" AND "+A[1]+" ) ";case"NOTBETWEEN":return A=this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" NOT BETWEEN "+A[0]+" AND "+A[1]+" ) ";case"LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)+") ";case"NOT LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)+") ";case"<>":case"=":if("column_ref"===u.left.type&&"string"===u.right.type){if(u.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[u.right.value.toString()])return" ("+h+" "+u.operator+" "+this.lkp[u.right.value.toString()].toString()+") "}else if("column_ref"===u.right.type&&"string"===u.left.type&&u.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[u.right.value.toString()].toString()+" "+u.operator+" "+h+") ";return" ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(u.left,r,o,m.BADNESS,c)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,r,o,m.BADNESS,c)+") "}throw new Error("Not Supported Operator "+u.operator);case"null":return"null";case"bool":return!0===u.value?"1":"0";case"string":return"'"+u.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,P.oX)(u.value,r);case"number":return u.value.toString();case"current_time":return(0,P.vR)("date"===u.mode,r);case"column_ref":return o&&o.toLowerCase()===u.column.toLowerCase()?"("+h+")":u.column;case"function":{const x=this.evaluateNodeToWhereClause(u.args,r,o,m.BADNESS,c);return(0,P.fz)(u.name,x,r)}}throw new Error("Unsupported sql syntax "+u.type)}extractValue(u){return this.codefield instanceof D.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(u)]:this.reverseLkp[u.attributes[this.codefield]]}}return m.BADNESS="_!!!_BAD_LKP_!!!!",m})();class p extends _{constructor(l,u){super(l),this.sql=u}rewriteSql(l,u){return{rewritten:!0,where:(0,P.bB)(l,this.field.name,(0,P.zR)(this.sql,T.Bj.Standardised),u.getFieldsIndex())}}extractValue(l){return this.sql.calculateValueCompiled(l)}}class v extends k.Z{constructor(l){super(l),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=l.extraFilter,this._parent=l.parentfeatureset,this._maxProcessing=30,this.adaptedFields=l.adaptedFields}static findField(l,u){for(const r of l)if(r.name.toLowerCase()===u.toString().toLowerCase())return r;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new L.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=T.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const l of this.adaptedFields)l.postInitialization(this,this._parent),this.fields.push(l.field)}_getSet(l){return null===this._wset?this._ensureLoaded().then(()=>this._extraFilter?this._getFilteredSet("",null,null,null,l):this._parent._getSet(l)).then(u=>(this._checkCancelled(l),this._wset=new E.Z(u._candidates.slice(0),u._known.slice(0),u._ordered,this._clonePageDefinition(u.pagesDefinition)),this._wset)):(0,w.DB)(this._wset)}_isInFeatureSet(l){return this._parent._isInFeatureSet(l)}_getFeatures(l,u,r,o){const h=[];-1!==u&&void 0===this._featureCache[u]&&h.push(u);const c=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(l,c))return this._expandPagedSet(l,c,0,0,o).then(()=>this._getFeatures(l,u,r,o));let F=0;for(let A=l._lastFetchedIndex;A<l._known.length&&(F++,F<=r&&(l._lastFetchedIndex+=1),!(void 0===this._featureCache[l._known[A]]&&(l._known[A]!==u&&h.push(l._known[A]),h.length>=c)));A++);if(0===h.length)return(0,w.DB)("success");l=new E.Z([],h,l._ordered,null);const j=Math.min(h.length,r);return this._parent._getFeatures(l,-1,j,o).then(()=>{this._checkCancelled(o);const A=[];for(let B=0;B<j;B++){const x=this._parent._featureFromCache(h[B]);void 0!==x&&A.push({geometry:x.geometry,attributes:x.attributes,id:h[B]})}for(const B of A){const x=[];for(const q of this.adaptedFields)x[q.field.name]=q.extractValue(B);this._featureCache[B.id]=new Q.Z({attributes:x,geometry:(0,U.r1)(B.geometry)})}return"success"})}_fetchAndRefineFeatures(){return(0,w.d1)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(l,u,r,o,h){let c=!1;const F=this._reformulateWithoutAdaptions(r);c=F.cannot,r=F.where;let j=!1;if(null!==o){j=!0;const A=[];for(const B of this.adaptedFields)if(!(B instanceof I)&&!0===o.scanForField(B.field.name)){if(!(B instanceof g)){o=null,j=!1;break}A.push({field:B.field.name,newfield:B.originalField.name})}o&&A.length>0&&(o=o.replaceFields(A))}return null!==r?null!==this._extraFilter&&(r=(0,P.$e)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then(()=>this._parent._getFilteredSet(l,u,r,o,h)).then(A=>{let B;return this._checkCancelled(h),B=!0===c?new E.Z(A._candidates.slice(0).concat(A._known.slice(0)),[],!0===j&&A._ordered,this._clonePageDefinition(A.pagesDefinition)):new E.Z(A._candidates.slice(0),A._known.slice(0),!0===j&&A._ordered,this._clonePageDefinition(A.pagesDefinition)),B})}_reformulateWithoutAdaptions(l){const u={cannot:!1,where:l};if(null!==l)for(const r of this.adaptedFields)if(!0===(0,P.hq)(l,r.field.name)){const o=r.rewriteSql(l,this);if(!0!==o.rewritten){u.cannot=!0,u.where=null;break}u.where=o.where}return u}_stat(l,u,r,o,h,c,F){let j=!1,A=this._reformulateWithoutAdaptions(u);return j=A.cannot,u=A.where,A=this._reformulateWithoutAdaptions(h),j=j||A.cannot,null!==(h=A.where)?null!==this._extraFilter&&(h=(0,P.$e)(this._extraFilter,h)):h=this._extraFilter,!0===j?null===h&&""===r&&null===o?this._manualStat(l,u,c,F):(0,w.DB)({calculated:!1}):this._parent._stat(l,u,r,o,h,c,F).then(B=>!1===B.calculated?null===h&&""===r&&null===o?this._manualStat(l,u,c,F):{calculated:!1}:B)}_canDoAggregates(l,u,r,o,h){if(null===this._parent)return(0,w.DB)(!1);for(let j=0;j<l.length;j++)for(const A of this.adaptedFields)if(l[j].toLowerCase()===A.field.name.toLowerCase()&&!(A instanceof I))return(0,w.DB)(!1);const c=[];for(let j=0;j<u.length;j++){const A=u[j];if(null!==A.workingexpr){const B=this._reformulateWithoutAdaptions(A.workingexpr);if(B.cannot)return(0,w.DB)(!1);const x=A.clone();x.workingexpr=B.where,c.push(x)}else c.push(A)}const F=this._reformulateWithoutAdaptions(h);return F.cannot?(0,w.DB)(!1):(null!==(h=F.where)?null!==this._extraFilter&&(h=(0,P.$e)(this._extraFilter,h)):h=this._extraFilter,this._parent._canDoAggregates(l,c,r,o,h))}_getAggregatePagesDataSourceDefinition(l,u,r,o,h,c,F){if(null===this._parent)return(0,w.d1)(new Error("Should never be called"));const j=[];for(let B=0;B<u.length;B++){const x=u[B];if(null!==x.workingexpr){const q=this._reformulateWithoutAdaptions(x.workingexpr);if(q.cannot)return(0,w.d1)(new Error("Should never be called"));const Z=x.clone();Z.workingexpr=q.where,j.push(Z)}else j.push(x)}const A=this._reformulateWithoutAdaptions(h);return A.cannot?(0,w.d1)(new Error("Should never be called")):(null!==(h=A.where)?null!==this._extraFilter&&(h=(0,P.$e)(this._extraFilter,h)):h=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(l,j,r,o,h,c,F))}}},53997:(J,W,y)=>{y.d(W,{Z:()=>D});var Q=y(49086),U=y(91510),k=y(77132),E=y(83947),T=y(10699),P=y(10410),w=y(65234);class D extends Q.Z{constructor(_){super(_),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=_.parentfeatureset,_.whereclause instanceof P.WhereClause?(this._whereclause=_.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=_.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new w.Z({wkid:4326}),this.geometryType=k.Qk.point)}_getSet(_){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getFilteredSet("",null,this._whereclause,null,_)).then(I=>(this._checkCancelled(_),this._wset=null!==this._whereClauseFunction?new U.Z(I._candidates.slice(0).concat(I._known.slice(0)),[],I._ordered,this._clonePageDefinition(I.pagesDefinition)):new U.Z(I._candidates.slice(0),I._known.slice(0),I._ordered,this._clonePageDefinition(I.pagesDefinition)),this._wset)):(0,T.DB)(this._wset)}_isInFeatureSet(_){let I=this._parent._isInFeatureSet(_);return I===k.dj.NotInFeatureSet?I:(I=this._idstates[_],void 0===I?k.dj.Unknown:I)}_getFeature(_,I,g){return this._parent._getFeature(_,I,g)}_getFeatures(_,I,g,C){return this._parent._getFeatures(_,I,g,C)}_featureFromCache(_){return this._parent._featureFromCache(_)}executeWhereClause(_){return this._whereclause.testFeature(_)}executeWhereClauseDeferred(_){if(null!==this._whereClauseFunction)try{const I=this._whereClauseFunction(_);return(0,T.y8)(I)?I:(0,T.DB)(I)}catch(I){return(0,T.d1)(I)}return(0,T.DB)(this.executeWhereClause(_))}_fetchAndRefineFeatures(_,I,g){const C=new U.Z([],_,!1,null),p=Math.min(I,_.length);return this._parent._getFeatures(C,-1,p,g).then(()=>{if(this._checkCancelled(g),null==this._whereClauseFunction){for(let m=0;m<p;m++){const l=this._parent._featureFromCache(_[m]);this._idstates[_[m]]=!0===this.executeWhereClause(l)?k.dj.InFeatureSet:k.dj.NotInFeatureSet}return"success"}const v=[];for(let m=0;m<p;m++){const l=this._parent._featureFromCache(_[m]);v.push(this.executeWhereClauseDeferred(l))}return(0,T.$6)(v).then(m=>{for(let l=0;l<I;l++)this._idstates[_[l]]=!0===m[l]?k.dj.InFeatureSet:k.dj.NotInFeatureSet;return"success"})})}_getFilteredSet(_,I,g,C,p){return null!==this._whereClauseFunction||(null!==g?null!==this._whereclause&&(g=(0,E.$e)(this._whereclause,g)):g=this._whereclause),this._ensureLoaded().then(()=>this._parent._getFilteredSet(_,I,g,C,p)).then(v=>{let m;return this._checkCancelled(p),m=null!==this._whereClauseFunction?new U.Z(v._candidates.slice(0).concat(v._known.slice(0)),[],v._ordered,this._clonePageDefinition(v.pagesDefinition)):new U.Z(v._candidates.slice(0),v._known.slice(0),v._ordered,this._clonePageDefinition(v.pagesDefinition)),m})}_stat(_,I,g,C,p,v,m){if(null!==this._whereClauseFunction)return null===p&&""===g&&null===C?this._manualStat(_,I,v,m):(0,T.DB)({calculated:!1});let l=this._whereclause;return null!==p&&null!==this._whereclause&&(l=(0,E.$e)(this._whereclause,p)),this._parent._stat(_,I,g,C,l,v,m).then(u=>!1===u.calculated?null===p&&""===g&&null===C?this._manualStat(_,I,v,m):{calculated:!1}:u)}_canDoAggregates(_,I,g,C,p){return null!==this._whereClauseFunction?(0,T.DB)(!1):(null!==p?null!==this._whereclause&&(p=(0,E.$e)(this._whereclause,p)):p=this._whereclause,null===this._parent?(0,T.DB)(!1):this._parent._canDoAggregates(_,I,g,C,p))}_getAggregatePagesDataSourceDefinition(_,I,g,C,p,v,m){return null===this._parent?(0,T.d1)(new Error("Should never be called")):(null!==p?null!==this._whereclause&&(p=(0,E.$e)(this._whereclause,p)):p=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(_,I,g,C,p,v,m))}static registerAction(){Q.Z._featuresetFunctions.filter=function(_){if("function"==typeof _)return new D({parentfeatureset:this,whereclause:_});let I=null;return _ instanceof P.WhereClause&&(I=_),new D({parentfeatureset:this,whereclause:I})}}}},95896:(J,W,y)=>{y.d(W,{Z:()=>P});var Q=y(47562),U=y(49086),k=y(91510),E=y(57366),T=y(10699);class P extends U.Z{constructor(D){super(D),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=D.orderbyclause,this._parent=D.parentfeatureset}_getSet(D){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,this._orderbyclause,D)).then(L=>(this._checkCancelled(D),this._wset=L,this._wset)):(0,T.DB)(this._wset)}manualOrderSet(D,L){return this.getIdColumnDictionary(D,[],-1,L).then(_=>{this._orderbyclause.order(_);const I=new k.Z([],[],!0,null);for(let g=0;g<_.length;g++)I._known.push(_[g].id);return I})}getIdColumnDictionary(D,L,_,I){if(_<D._known.length-1){const g=this._maxQueryRate();if("GETPAGES"===D._known[_+1])return(0,Q.X)(this._parent._expandPagedSet(D,g,0,0,I)).then(()=>this.getIdColumnDictionary(D,L,_,I));let C=_+1;const p=[];for(;C<D._known.length&&"GETPAGES"!==D._known[C];)p.push(D._known[C]),C++;return _+=p.length,(0,Q.X)(this._parent._getFeatureBatch(p,I)).then(v=>{this._checkCancelled(I);for(const m of v)L.push({id:m.attributes[this.objectIdField],feature:m});return this.getIdColumnDictionary(D,L,_,I)})}return D._candidates.length>0?(0,Q.X)(this._refineSetBlock(D,this._maxProcessingRate(),I)).then(()=>(this._checkCancelled(I),this.getIdColumnDictionary(D,L,_,I))):(0,T.DB)(L)}_isInFeatureSet(D){return this._parent._isInFeatureSet(D)}_getFeatures(D,L,_,I){return this._parent._getFeatures(D,L,_,I)}_featureFromCache(D){if(void 0===this._featureCache[D]){const L=this._parent._featureFromCache(D);return void 0===L?void 0:null===L?null:(this._featureCache[D]=L,L)}return this._featureCache[D]}_fetchAndRefineFeatures(){return(0,T.d1)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(D,L,_,I,g){return this._ensureLoaded().then(()=>this._parent._getFilteredSet(D,L,_,null===I?this._orderbyclause:I,g)).then(C=>{this._checkCancelled(g);const p=new k.Z(C._candidates.slice(0),C._known.slice(0),C._ordered,this._clonePageDefinition(C.pagesDefinition));let v=!0;return C._candidates.length>0&&(v=!1),!1===p._ordered?this.manualOrderSet(p,g).then(m=>(!1===v&&(null===L&&null===_||(m=new k.Z(m._candidates.slice(0).concat(m._known.slice(0)),[],m._ordered,this._clonePageDefinition(m.pagesDefinition)))),m)):p})}static registerAction(){U.Z._featuresetFunctions.orderBy=function(D){return""===D?this:new P({parentfeatureset:this,orderbyclause:new E.Z(D)})}}}},79429:(J,W,y)=>{y.d(W,{Z:()=>T});var Q=y(49086),U=y(91510),k=y(77132),E=y(10699);class T extends Q.Z{constructor(w){super(w),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=w.topnum,this._parent=w.parentfeatureset}_getSet(w){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getSet(w)).then(D=>(this._wset=new U.Z(D._candidates.slice(0),D._known.slice(0),!1,this._clonePageDefinition(D.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset)):(0,E.DB)(this._wset)}_setKnownLength(w){return w._known.length>0&&"GETPAGES"===w._known[w._known.length-1]?w._known.length-1:w._known.length}_isInFeatureSet(w){const D=this._parent._isInFeatureSet(w);if(D===k.dj.NotInFeatureSet)return D;const L=this._idstates[w];return L===k.dj.InFeatureSet||L===k.dj.NotInFeatureSet?L:D===k.dj.InFeatureSet&&void 0===L?this._countedin<this._topnum?(this._idstates[w]=k.dj.InFeatureSet,this._countedin++,k.dj.InFeatureSet):(this._idstates[w]=k.dj.NotInFeatureSet,k.dj.NotInFeatureSet):k.dj.Unknown}_expandPagedSet(w,D,L,_,I){if(null===this._parent)return(0,E.d1)(new Error("Parent Paging not implemented"));if(D>this._topnum&&(D=this._topnum),this._countedin>=this._topnum&&w.pagesDefinition.internal.set.length<=w.pagesDefinition.resultOffset){let g=w._known.length;return g>0&&"GETPAGES"===w._known[g-1]&&(w._known.length=g-1),g=w._candidates.length,g>0&&"GETPAGES"===w._candidates[g-1]&&(w._candidates.length=g-1),(0,E.DB)("success")}return this._parent._expandPagedSet(w,D,L,_,I).then(g=>(this._setKnownLength(w)>this._topnum&&(w._known.length=this._topnum),this._setKnownLength(w)>=this._topnum&&(w._candidates.length=0),g))}_getFeatures(w,D,L,_){const I=[],g=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(w,g))return this._expandPagedSet(w,g,0,0,_).then(()=>this._getFeatures(w,D,L,_));-1!==D&&void 0===this._featureCache[D]&&I.push(D);let C=0;for(let m=w._lastFetchedIndex;m<w._known.length&&(C++,C<=L&&(w._lastFetchedIndex+=1),!(void 0===this._featureCache[w._known[m]]&&(w._known[m]!==D&&I.push(w._known[m]),I.length>g)));m++);if(0===I.length)return(0,E.DB)("success");const p=new U.Z([],I,!1,null),v=Math.min(I.length,L);return this._parent._getFeatures(p,-1,v,_).then(()=>{for(let m=0;m<v;m++){const l=this._parent._featureFromCache(I[m]);void 0!==l&&(this._featureCache[I[m]]=l)}return"success"})}_getFilteredSet(w,D,L,_,I){return this._ensureLoaded().then(()=>this._getSet(I)).then(g=>new U.Z(g._candidates.slice(0).concat(g._known.slice(0)),[],!1,this._clonePageDefinition(g.pagesDefinition)))}_refineKnowns(w,D){let L=0,_=null;const I=[];for(let g=0;g<w._candidates.length;g++){const C=this._isInFeatureSet(w._candidates[g]);if(C===k.dj.InFeatureSet){if(w._known.push(w._candidates[g]),L+=1,null===_?_={start:g,end:g}:_.end===g-1?_.end=g:(I.push(_),_={start:g,end:g}),w._known.length>=this._topnum)break}else if(C===k.dj.NotInFeatureSet)null===_?_={start:g,end:g}:_.end===g-1?_.end=g:(I.push(_),_={start:g,end:g}),L+=1;else if(C===k.dj.Unknown)break;if(L>=D)break}null!==_&&I.push(_);for(let g=I.length-1;g>=0;g--)w._candidates.splice(I[g].start,I[g].end-I[g].start+1);this._setKnownLength(w)>this._topnum&&(w._known=w._known.slice(0,this._topnum)),this._setKnownLength(w)>=this._topnum&&(w._candidates=[])}_stat(){return(0,E.DB)({calculated:!1})}_canDoAggregates(){return(0,E.DB)(!1)}static registerAction(){Q.Z._featuresetFunctions.top=function(w){return new T({parentfeatureset:this,topnum:w})}}}},16776:(J,W,y)=>{y.d(W,{Z:()=>g});var Q=y(88879),U=y(49086),k=y(91510),E=y(77132),T=y(83947),P=y(10699),w=y(21674),D=y(15382),L=y(41638),_=y(36255),I=y(84952);class g extends U.Z{constructor(p){super(p),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,p.spatialReference&&(this.spatialReference=p.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=p.layer,this._wset=null,!0===p.isTable&&(this._forceIsTable=!0),void 0!==p.outFields&&(this._overrideFields=p.outFields),void 0!==p.includeGeometry&&(this._removeGeometry=!1===p.includeGeometry)}_maxQueryRate(){return E.tI}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,P.Ue)((p,v)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void p(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),p(this)}catch(m){v(m)}},v),this._layer.load()})),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const p=[];for(const v of this.fields)if("oid"===v.type)p.push(v);else for(const m of this._layer.outFields)if(m.toLowerCase()===v.name.toLowerCase()){p.push(v);break}this.fields=p}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const p=[],v=[];for(const m of this.fields)if("oid"===m.type)p.push(m),v.push(m.name);else for(const l of this._overrideFields)if(l.toLowerCase()===m.name.toLowerCase()){p.push(m),v.push(m.name);break}this.fields=p,this._overrideFields=v}this.objectIdField=this._layer.objectIdField;for(const p of this.fields)"global-id"===p.type&&(this.globalIdField=p.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=E.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return E.dj.InFeatureSet}_candidateIdTransform(p){return p}_getSet(p){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,p)).then(v=>(this._wset=v,v)):(0,P.DB)(this._wset)}_changeFeature(p){const v={};for(const m of this.fields)v[m.name]=p.attributes[m.name];return new Q.Z({geometry:!0===this._removeGeometry?null:p.geometry,attributes:v})}_getFilteredSet(p,v,m,l,u){let r="",o=!1;if(null!==l&&(r=l.constructClause(),o=!0),this.isTable()&&v&&null!==p&&""!==p){const c=new k.Z([],[],!0,null);return(0,P.DB)(c)}const h=new I.Z;return h.where=null===m?null===v?"1=1":"":(0,T.zR)(m,E.Bj.Standardised),h.spatialRelationship=this._makeRelationshipEnum(p),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==r?r.split(","):null,h.geometry=null===v?null:v,h.returnGeometry=!0,h.relationParameter=this._makeRelationshipParam(p),this._layer.queryFeatures(h).then(c=>{if(null===c)return new k.Z([],[],o,null);this._checkCancelled(u);const F=[];return c.features.forEach(j=>{const A=j.attributes[this._layer.objectIdField];F.push(A),this._featureCache[A]=this._changeFeature(j)}),new k.Z([],F,o,null)})}_makeRelationshipEnum(p){if(p.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(p){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return p}_makeRelationshipParam(p){return p.indexOf("esriSpatialRelRelation")>=0?p.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return(0,P.DB)(this._wset);const p=new I.Z;return p.where="1=1",this._ensureLoaded().then(()=>{if(this._layer.source&&this._layer.source.items){const v=[];return this._layer.source.items.forEach(m=>{const l=m.attributes[this._layer.objectIdField];v.push(l),this._featureCache[l]=this._changeFeature(m)}),this._wset=new k.Z([],v,!1,null),this._wset}return this._layer.queryFeatures(p).then(v=>{const m=[];return v.features.forEach(l=>{const u=l.attributes[this._layer.objectIdField];m.push(u),this._featureCache[u]=this._changeFeature(l)}),this._wset=new k.Z([],m,!1,null),this._wset})})}_getFeatures(p,v,m){const l=[];-1!==v&&void 0===this._featureCache[v]&&l.push(v);for(let u=p._lastFetchedIndex;u<p._known.length&&(p._lastFetchedIndex+=1,!(void 0===this._featureCache[p._known[u]]&&(p._known[u]!==v&&l.push(p._known[u]),l.length>m)));u++);return 0===l.length?(0,P.DB)("success"):(0,P.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(p){return(0,P.DB)(p)}_stat(){return(0,P.DB)({calculated:!1})}_canDoAggregates(){return(0,P.DB)(!1)}relationshipMetaData(){return[]}static _cloneAttr(p){const v={};for(const m in p)v[m]=p[m];return v}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(p,v){let m=p.layerDefinition.objectIdField;const l=p.layerDefinition.typeIdField?p.layerDefinition.typeIdField:"",u=[];if(p.layerDefinition.types)for(const B of p.layerDefinition.types)u.push(L.Z.fromJSON(B));let r=p.layerDefinition.geometryType;void 0===r&&(r=p.featureSet.geometryType||"");let o=p.featureSet.features;const h=v.toJSON();if(""===m||void 0===m){let B=!1;for(const x of p.layerDefinition.fields)if("oid"===x.type||"esriFieldTypeOID"===x.type){m=x.name,B=!0;break}if(!1===B){let x="FID",q=!0,Z=0;for(;q;){let $=!0;for(const oe of p.layerDefinition.fields)if(oe.name===x){$=!1;break}!0===$?q=!1:(Z++,x="FID"+Z.toString())}p.layerDefinition.fields.push({type:"esriFieldTypeOID",name:x,alias:x});const te=[];for(let $=0;$<o.length;$++)te.push({geometry:p.featureSet.features[$].geometry,attributes:p.featureSet.features[$].attributes?this._cloneAttr(p.featureSet.features[$].attributes):{}}),te[$].attributes[x]=$;o=te,m=x}}const c=[];for(const B of p.layerDefinition.fields)c.push(B instanceof _.Z?B:_.Z.fromJSON(B));let F=r;switch(F){case"esriGeometryPoint":F="point";break;case"esriGeometryPolyline":F="polyline";break;case"esriGeometryPolygon":F="polygon";break;case"esriGeometryExtent":F="extent";break;case"esriGeometryMultipoint":F="multipoint"}for(const B of o)B.geometry&&!(B.geometry instanceof w.Z)&&(B.geometry.type=F,void 0===B.geometry.spatialReference&&(B.geometry.spatialReference=h));const j={outFields:["*"],source:o,fields:c,types:u,typeIdField:l,objectIdField:m,spatialReference:v};j.geometryType=F||"point";const A=new D.default(j);return new g({layer:A,spatialReference:v,isTable:null===F||""===F})}queryAttachments(){return(0,P.DB)([])}getFeatureByObjectId(p){const v=new I.Z;return v.where=this.objectIdField+"="+p.toString(),this._layer.queryFeatures(v).then(m=>1===m.features.length?m.features[0]:null)}getOwningSystemUrl(){return(0,P.DB)("")}getIdentityUser(){return(0,P.DB)("")}}},57366:(J,W,y)=>{function Q(k,E){return k===E?0:null===k?-1:null===E?1:k<E?-1:1}y.d(W,{Z:()=>U});class U{constructor(E){const T=E.split(",");this._fields=[],this._directions=[];for(let P=0;P<T.length;P++){const w=T[P].match(/\S+/g);this._fields.push(w[0]),2===w.length?"asc"===w[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let E="";for(let T=0;T<this._fields.length;T++)0!==T&&(E+=","),E+=this._fields[T],E+=1===this._directions[T]?" ASC":" DESC";return E}order(E){E.sort((T,P)=>{for(let w=0;w<this._fields.length;w++){const D=this.featureValue(T.feature,this._fields[w],w),L=this.featureValue(P.feature,this._fields[w],w);let _=0;if(_=1===this._directions[w]?Q(D,L):-1*Q(D,L),0!==_)return _}return 0})}scanForField(E){for(let T=0;T<this._fields.length;T++)if(this._fields[T].toLowerCase().trim()===E.toLowerCase().trim())return!0;return!1}replaceFields(E){let T="";for(let P=0;P<this._fields.length;P++){0!==P&&(T+=",");let w=this._fields[P];for(const D of E)if(w.toLowerCase()===D.field.toLowerCase()){w=D.newfield;break}T+=w,T+=1===this._directions[P]?" ASC":" DESC"}return new U(T)}featureValue(E,T,P){const w=E.attributes[T];if(void 0!==w)return w;for(const D in E.attributes)if(T.toLowerCase()===D.toLowerCase())return this._fields[P]=D,E.attributes[D];return null}}},50011:(J,W,y)=>{y.d(W,{F:()=>m,M:()=>Q});const Q={Base64:0,Hex:1,String:2,Raw:3};function E(l,u){const r=(65535&l)+(65535&u);return(l>>16)+(u>>16)+(r>>16)<<16|65535&r}function _(l,u,r,o,h,c){return E(function L(l,u){return l<<u|l>>>32-u}(E(E(u,l),E(o,c)),h),r)}function I(l,u,r,o,h,c,F){return _(u&r|~u&o,l,u,h,c,F)}function g(l,u,r,o,h,c,F){return _(u&o|r&~o,l,u,h,c,F)}function C(l,u,r,o,h,c,F){return _(u^r^o,l,u,h,c,F)}function p(l,u,r,o,h,c,F){return _(r^(u|~o),l,u,h,c,F)}function m(l,u=Q.Hex){const r=u||Q.Base64,o=function v(l,u){l[u>>5]|=128<<u%32,l[14+(u+64>>>9<<4)]=u;let r=1732584193,o=-271733879,h=-1732584194,c=271733878;for(let F=0;F<l.length;F+=16){const j=r,A=o,B=h,x=c;r=I(r,o,h,c,l[F+0],7,-680876936),c=I(c,r,o,h,l[F+1],12,-389564586),h=I(h,c,r,o,l[F+2],17,606105819),o=I(o,h,c,r,l[F+3],22,-1044525330),r=I(r,o,h,c,l[F+4],7,-176418897),c=I(c,r,o,h,l[F+5],12,1200080426),h=I(h,c,r,o,l[F+6],17,-1473231341),o=I(o,h,c,r,l[F+7],22,-45705983),r=I(r,o,h,c,l[F+8],7,1770035416),c=I(c,r,o,h,l[F+9],12,-1958414417),h=I(h,c,r,o,l[F+10],17,-42063),o=I(o,h,c,r,l[F+11],22,-1990404162),r=I(r,o,h,c,l[F+12],7,1804603682),c=I(c,r,o,h,l[F+13],12,-40341101),h=I(h,c,r,o,l[F+14],17,-1502002290),o=I(o,h,c,r,l[F+15],22,1236535329),r=g(r,o,h,c,l[F+1],5,-165796510),c=g(c,r,o,h,l[F+6],9,-1069501632),h=g(h,c,r,o,l[F+11],14,643717713),o=g(o,h,c,r,l[F+0],20,-373897302),r=g(r,o,h,c,l[F+5],5,-701558691),c=g(c,r,o,h,l[F+10],9,38016083),h=g(h,c,r,o,l[F+15],14,-660478335),o=g(o,h,c,r,l[F+4],20,-405537848),r=g(r,o,h,c,l[F+9],5,568446438),c=g(c,r,o,h,l[F+14],9,-1019803690),h=g(h,c,r,o,l[F+3],14,-187363961),o=g(o,h,c,r,l[F+8],20,1163531501),r=g(r,o,h,c,l[F+13],5,-1444681467),c=g(c,r,o,h,l[F+2],9,-51403784),h=g(h,c,r,o,l[F+7],14,1735328473),o=g(o,h,c,r,l[F+12],20,-1926607734),r=C(r,o,h,c,l[F+5],4,-378558),c=C(c,r,o,h,l[F+8],11,-2022574463),h=C(h,c,r,o,l[F+11],16,1839030562),o=C(o,h,c,r,l[F+14],23,-35309556),r=C(r,o,h,c,l[F+1],4,-1530992060),c=C(c,r,o,h,l[F+4],11,1272893353),h=C(h,c,r,o,l[F+7],16,-155497632),o=C(o,h,c,r,l[F+10],23,-1094730640),r=C(r,o,h,c,l[F+13],4,681279174),c=C(c,r,o,h,l[F+0],11,-358537222),h=C(h,c,r,o,l[F+3],16,-722521979),o=C(o,h,c,r,l[F+6],23,76029189),r=C(r,o,h,c,l[F+9],4,-640364487),c=C(c,r,o,h,l[F+12],11,-421815835),h=C(h,c,r,o,l[F+15],16,530742520),o=C(o,h,c,r,l[F+2],23,-995338651),r=p(r,o,h,c,l[F+0],6,-198630844),c=p(c,r,o,h,l[F+7],10,1126891415),h=p(h,c,r,o,l[F+14],15,-1416354905),o=p(o,h,c,r,l[F+5],21,-57434055),r=p(r,o,h,c,l[F+12],6,1700485571),c=p(c,r,o,h,l[F+3],10,-1894986606),h=p(h,c,r,o,l[F+10],15,-1051523),o=p(o,h,c,r,l[F+1],21,-2054922799),r=p(r,o,h,c,l[F+8],6,1873313359),c=p(c,r,o,h,l[F+15],10,-30611744),h=p(h,c,r,o,l[F+6],15,-1560198380),o=p(o,h,c,r,l[F+13],21,1309151649),r=p(r,o,h,c,l[F+4],6,-145523070),c=p(c,r,o,h,l[F+11],10,-1120210379),h=p(h,c,r,o,l[F+2],15,718787259),o=p(o,h,c,r,l[F+9],21,-343485551),r=E(r,j),o=E(o,A),h=E(h,B),c=E(c,x)}return[r,o,h,c]}(function T(l){const u=[];for(let r=0,o=8*l.length;r<o;r+=8)u[r>>5]|=(255&l.charCodeAt(r/8))<<r%32;return u}(l),8*l.length);switch(r){case Q.Raw:return o;case Q.Hex:return function w(l){const u="0123456789abcdef",r=[];for(let o=0,h=4*l.length;o<h;o++)r.push(u.charAt(l[o>>2]>>o%4*8+4&15)+u.charAt(l[o>>2]>>o%4*8&15));return r.join("")}(o);case Q.String:return function P(l){const u=[];for(let r=0,o=32*l.length;r<o;r+=8)u.push(String.fromCharCode(l[r>>5]>>>r%32&255));return u.join("")}(o);case Q.Base64:return function D(l){const o=[];for(let h=0,c=4*l.length;h<c;h+=3){const F=(l[h>>2]>>h%4*8&255)<<16|(l[h+1>>2]>>(h+1)%4*8&255)<<8|l[h+2>>2]>>(h+2)%4*8&255;for(let j=0;j<4;j++)o.push(8*h+6*j>32*l.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(F>>6*(3-j)&63))}return o.join("")}(o)}}}}]);