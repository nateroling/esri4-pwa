"use strict";(self.webpackChunkesri4_pwa=self.webpackChunkesri4_pwa||[]).push([[2480],{82480:(pe,K,D)=>{D.r(K),D.d(K,{registerFunctions:()=>ce});var $=D(37780),w=D(6729),ee=D(42275),G=D(90512),O=D(85171),te=D(7652),ne=D(98362),r=D(47562),h=D(52724),z=D(53997),re=D(95896),ae=D(79429),se=D(62074),ie=D(16776),le=D(57366),R=D(77132),H=D(83947),W=D(50818),A=D(10699),_=D(10410),B=D(15382),S=D(36255);function j(t,s,p){const y=t.getVariables();if(y.length>0){const F=[];for(let e=0;e<y.length;e++)F.push(s.evaluateIdentifier(p,{name:y[e]}));return(0,A.$6)(F).then(e=>{const i={};for(let n=0;n<y.length;n++)i[y[n]]=e[n];return t.parameters=i,t})}return(0,A.DB)(t)}function c(t,s,p=null){for(const y in t)if(y.toLowerCase()===s.toLowerCase())return t[y];return p}function X(t){if(null===t)return null;const s={type:c(t,"type",""),name:c(t,"name","")};if("range"===s.type)s.range=c(t,"range",[]);else{s.codedValues=[];for(const p of c(t,"codedValues",[]))s.codedValues.push({name:c(p,"name",""),code:c(p,"code",null)})}return s}function U(t){if(null===t)return null;const s={},p=c(t,"wkt",null);null!==p&&(s.wkt=p);const y=c(t,"wkid",null);return null!==y&&(s.wkid=y),s}function J(t){if(null===t)return null;const s={hasZ:c(t,"hasz",!1),hasM:c(t,"hasm",!1)},p=c(t,"spatialreference",null);p&&(s.spatialReference=U(p));const y=c(t,"x",null);if(null!==y)return s.x=y,s.y=c(t,"y",null),s;const F=c(t,"rings",null);if(null!==F)return s.rings=F,s;const e=c(t,"paths",null);if(null!==e)return s.paths=e,s;const i=c(t,"points",null);if(null!==i)return s.points=i,s;for(const n of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const u=c(t,n,null);null!==u&&(s[n]=u)}return s}function ce(t){"async"===t.mode&&(t.functions.getuser=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{(0,r.p)(e,1,2);let i=(0,r.C)(e[1],""),n=!0===i;if(i=!0===i||!1===i?"":(0,r.d)(i),e[0]instanceof $.Z){let m=null;return s.services&&s.services.portal&&(m=s.services.portal),m=(0,O.getPortal)(e[0],m),(0,O.lookupUser)(m,i,n).then(o=>{if(o){const l=JSON.parse(JSON.stringify(o));for(const a of["lastLogin","created","modified"])null!=l[a]&&(l[a]=new Date(l[a]));return w.Z.convertObjectToArcadeDictionary(l)}return null})}let u=null;if((0,r.q)(e[0])&&(u=e[0]),u)return n=!1,i?null:u.load().then(()=>u.getOwningSystemUrl()).then(m=>{if(!m)return i?null:u.getIdentityUser().then(l=>l?w.Z.convertObjectToArcadeDictionary({username:l}):null);let o=null;return s.services&&s.services.portal&&(o=s.services.portal),o=(0,O.getPortal)(new $.Z(m),o),(0,O.lookupUser)(o,i,n).then(l=>{if(l){const a=JSON.parse(JSON.stringify(l));for(const f of["lastLogin","created","modified"])null!=a[f]&&(a[f]=new Date(a[f]));return w.Z.convertObjectToArcadeDictionary(a)}return null})});throw new Error("Invalid Parameter")})},t.signatures.push({name:"getuser",min:"1",max:"2"}),t.functions.featuresetbyid=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{if((0,r.p)(e,2,4),e[0]instanceof G.Z){const i=(0,r.d)(e[1]);let n=(0,r.C)(e[2],null);const u=(0,r.z)((0,r.C)(e[3],!0));if(null===n&&(n=["*"]),!1===(0,r.a)(n))throw new Error("Invalid Parameter");return e[0].featureSetById(i,u,n)}throw new Error("Invalid Parameter")})},t.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),t.functions.getfeatureset=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{if((0,r.p)(e,1,2),(0,r.k)(e[0])){let i=(0,r.C)(e[1],"datasource");return null===i&&(i="datasource"),i=(0,r.d)(i).toLowerCase(),(0,O.convertToFeatureSet)(e[0].fullSchema(),i,s.lrucache,s.interceptor,s.spatialReference)}throw new Error("Invalid Parameter")})},t.signatures.push({name:"getfeatureset",min:"1",max:"2"}),t.functions.featuresetbyportalitem=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{if((0,r.p)(e,2,5),null===e[0])throw new Error("Portal is required");if(e[0]instanceof $.Z){const o=(0,r.d)(e[1]),l=(0,r.d)(e[2]);let a=(0,r.C)(e[3],null);const f=(0,r.z)((0,r.C)(e[4],!0));if(null===a&&(a=["*"]),!1===(0,r.a)(a))throw new Error("Invalid Parameter");let d=null;return s.services&&s.services.portal&&(d=s.services.portal),d=(0,O.getPortal)(e[0],d),(0,O.constructFeatureSetFromPortalItem)(o,l,s.spatialReference,a,f,d,s.lrucache,s.interceptor)}if(!1===(0,r.f)(e[0]))throw new Error("Portal is required");const i=(0,r.d)(e[0]),n=(0,r.d)(e[1]);let u=(0,r.C)(e[2],null);const m=(0,r.z)((0,r.C)(e[3],!0));if(null===u&&(u=["*"]),!1===(0,r.a)(u))throw new Error("Invalid Parameter");if(s.services&&s.services.portal)return(0,O.constructFeatureSetFromPortalItem)(i,n,s.spatialReference,u,m,s.services.portal,s.lrucache,s.interceptor);throw new Error("Portal is required")})},t.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),t.functions.featuresetbyname=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{if((0,r.p)(e,2,4),e[0]instanceof G.Z){const i=(0,r.d)(e[1]);let n=(0,r.C)(e[2],null);const u=(0,r.z)((0,r.C)(e[3],!0));if(null===n&&(n=["*"]),!1===(0,r.a)(n))throw new Error("Invalid Parameter");return e[0].featureSetByName(i,u,n)}throw new Error("Invalid Parameter")})},t.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),t.functions.featureset=function(s,p){return t.standardFunction(s,p,(y,F,e)=>{(0,r.p)(e,1,1);let i=e[0];const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if((0,r.f)(i))i=JSON.parse(i),void 0!==i.layerDefinition?(n.layerDefinition=i.layerDefinition,n.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(n.featureSet.features=i.features,n.featureSet.geometryType=i.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=i.objectIdFieldName,n.layerDefinition.typeIdField=i.typeIdFieldName,n.layerDefinition.globalIdField=i.globalIdFieldName,n.layerDefinition.fields=i.fields,i.spatialReference&&(n.layerDefinition.spatialReference=i.spatialReference));else{if(!(e[0]instanceof w.Z))throw new Error("Invalid Parameter");{i=JSON.parse(e[0].castToText());const u=c(i,"layerdefinition");if(null!==u){n.layerDefinition.geometryType=c(u,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=c(u,"globalidfield",""),n.layerDefinition.objectIdField=c(u,"objectidfield",""),n.layerDefinition.typeIdField=c(u,"typeidfield","");const m=c(u,"spatialreference",null);m&&(n.layerDefinition.spatialReference=U(m));for(const l of c(u,"fields",[])){const a={name:c(l,"name",""),alias:c(l,"alias",""),type:c(l,"type",""),nullable:c(l,"nullable",!0),editable:c(l,"editable",!0),length:c(l,"length",null),domain:X(c(l,"domain"))};n.layerDefinition.fields.push(a)}const o=c(i,"featureset",null);if(o){const l={};for(const a of n.layerDefinition.fields)l[a.name.toLowerCase()]=a.name;for(const a of c(o,"features",[])){const f={},d=c(a,"attributes",{});for(const I in d)f[l[I.toLowerCase()]]=d[I];n.featureSet.features.push({attributes:f,geometry:J(c(a,"geometry",null))})}}}else{n.layerDefinition.geometryType=c(i,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=c(i,"objectidfieldname",""),n.layerDefinition.typeIdField=c(i,"typeidfieldname","");const m=c(i,"spatialreference",null);m&&(n.layerDefinition.spatialReference=U(m));for(const l of c(i,"fields",[])){const a={name:c(l,"name",""),alias:c(l,"alias",""),type:c(l,"type",""),nullable:c(l,"nullable",!0),editable:c(l,"editable",!0),length:c(l,"length",null),domain:X(c(l,"domain"))};n.layerDefinition.fields.push(a)}const o={};for(const l of n.layerDefinition.fields)o[l.name.toLowerCase()]=l.name;for(const l of c(i,"features",[])){const a={},f=c(l,"attributes",{});for(const d in f)a[o[d.toLowerCase()]]=f[d];n.featureSet.features.push({attributes:a,geometry:J(c(l,"geometry",null))})}}}}if(!1===function fe(t){return!!t.layerDefinition&&!!t.featureSet&&!1!==function ue(t,s){for(const p of s)if(p===t)return!0;return!1}(t.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&null!==t.layerDefinition.objectIdField&&""!==t.layerDefinition.objectIdField&&!1!==(0,r.a)(t.layerDefinition.fields)&&!1!==(0,r.a)(t.featureSet.features)}(n))throw new Error("Invalid Parameter");return ie.Z.create(n,s.spatialReference)})},t.signatures.push({name:"featureset",min:"1",max:"1"}),t.functions.filter=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{if((0,r.p)(e,2,2),(0,r.a)(e[0])||(0,r.b)(e[0])){const i=[];let n=e[0];n instanceof ne.Z&&(n=n.toArray());let u=null;if(e[1]instanceof te.Z)u=t.arcadeCustomFunctionHandler(e[1]);else if(e[1]instanceof r.N)u=(...m)=>e[1].fn(s,{preparsed:!0,arguments:m});else{if(!(e[1]instanceof r.S))throw new Error("Invalid Parameter");u=(...m)=>{if(m.length!==e[1].paramCount)throw new Error("Invalid parameters");return e[1].fn(...m)}}return n.reduce((m,o,l)=>m.then(a=>{l>0&&!0===a&&i.push(n[l-1]);const f=u(o);return(0,A.y8)(f)?f:(0,A.DB)(f)}),Promise.resolve(!1)).then(m=>(!0===m&&n.length>0&&i.push(n[n.length-1]),i))}return(0,r.q)(e[0])?e[0].load().then(i=>{const n=_.WhereClause.create(e[1],i.getFieldsIndex()),u=n.getVariables();if(u.length>0){const m=[];for(let o=0;o<u.length;o++)m.push(t.evaluateIdentifier(s,{name:u[o]}));return(0,A.$6)(m).then(o=>{const l={};for(let a=0;a<u.length;a++)l[u[a]]=o[a];return n.parameters=l,new z.Z({parentfeatureset:e[0],whereclause:n})})}return(0,A.DB)(new z.Z({parentfeatureset:e[0],whereclause:n}))}):t.failDefferred("Filter cannot accept this parameter type")})},t.signatures.push({name:"filter",min:"2",max:"2"}),t.functions.orderby=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{if((0,r.p)(e,2,2),(0,r.q)(e[0])){const i=new le.Z(e[1]);return(0,A.DB)(new re.Z({parentfeatureset:e[0],orderbyclause:i}))}return t.failDefferred("Order cannot accept this parameter type")})},t.signatures.push({name:"orderby",min:"2",max:"2"}),t.functions.top=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>((0,r.p)(e,2,2),(0,r.q)(e[0])?(0,A.DB)(new ae.Z({parentfeatureset:e[0],topnum:e[1]})):(0,r.a)(e[0])?(0,r.t)(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,(0,r.t)(e[1])):(0,r.b)(e[0])?(0,r.t)(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,(0,r.t)(e[1])):t.failDefferred("Top cannot accept this parameter type")))},t.signatures.push({name:"top",min:"2",max:"2"}),t.functions.first=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>((0,r.p)(e,1,1),(0,r.q)(e[0])?e[0].first(y.abortSignal).then(i=>{if(null!==i){const n=ee.Z.createFromGraphicLikeObject(i.geometry,i.attributes,e[0]);n._underlyingGraphic=i,i=n}return i}):(0,r.a)(e[0])?(0,A.DB)(0===e[0].length?null:e[0][0]):(0,r.b)(e[0])?0===e[0].length()?(0,A.DB)(null):(0,A.DB)(e[0].get(0)):null))},t.signatures.push({name:"first",min:"1",max:"1"}),t.functions.attachments=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{(0,r.p)(e,1,2);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1)if(e[1]instanceof w.Z){if(e[1].hasField("minsize")&&(i.minsize=(0,r.t)(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=(0,r.z)(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=(0,r.t)(e[1].field("maxsize"))),e[1].hasField("types")){const n=(0,r.Y)(e[1].field("types"),!1);n.length>0&&(i.types=n)}}else if(null!==e[1])throw new Error("Invalid Parameter");if((0,r.k)(e[0])){let n=e[0]._layer;return n instanceof B.default&&(n=(0,O.constructFeatureSet)(n,s.spatialReference,["*"],!0,s.lrucache,s.interceptor)),null===n||!1===(0,r.q)(n)?[]:n.load().then(()=>n.queryAttachments(e[0].field(n.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata))}if(null===e[0])return[];throw new Error("Invalid Parameter")})},t.signatures.push({name:"attachments",min:"1",max:"2"}),t.functions.featuresetbyrelationshipname=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{(0,r.p)(e,2,4);const i=e[0],n=(0,r.d)(e[1]);let u=(0,r.C)(e[2],null);const m=(0,r.z)((0,r.C)(e[3],!0));if(null===u&&(u=["*"]),!1===(0,r.a)(u))throw new Error("Invalid Parameter");if(null===e[0])return null;if(!(0,r.k)(e[0]))throw new Error("Invalid Parameter");let o=i._layer;return o instanceof B.default&&(o=(0,O.constructFeatureSet)(o,s.spatialReference,["*"],!0,s.lrucache,s.interceptor)),null===o||!1===(0,r.q)(o)?null:o.load().then(l=>{const a=l.relationshipMetaData().filter(d=>d.name===n);if(0===a.length)return null;if(null!=a[0].relationshipTableId&&a[0].relationshipTableId>-1)return(0,O.constructFeatureSetFromRelationship)(l,a[0],i.field(l.objectIdField),l.spatialReference,u,m,s.lrucache,s.interceptor);let f=l.serviceUrl();return f?(f="/"===f.charAt(f.length-1)?f+a[0].relatedTableId.toString():f+"/"+a[0].relatedTableId.toString(),(0,O.constructFeatureSetFromUrl)(f,l.spatialReference,u,m,s.lrucache,s.interceptor).then(d=>d.load().then(()=>d.relationshipMetaData()).then(I=>{if(I=I.filter(N=>N.id===a[0].id),!1===i.hasField(a[0].keyField)||null===i.field(a[0].keyField))return l.getFeatureByObjectId(i.field(l.objectIdField),[a[0].keyField]).then(N=>{if(N){const L=_.WhereClause.create(I[0].keyField+"= @id",d.getFieldsIndex());return L.parameters={id:N.attributes[a[0].keyField]},d.filter(L)}return new se.Z({parentfeatureset:d})});const C=_.WhereClause.create(I[0].keyField+"= @id",d.getFieldsIndex());return C.parameters={id:i.field(a[0].keyField)},d.filter(C)}))):null})})},t.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),t.functions.featuresetbyassociation=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>{(0,r.p)(e,2,3);const i=e[0],n=(0,r.d)((0,r.C)(e[1],"")).toLowerCase(),u=(0,r.f)(e[2])?(0,r.d)(e[2]):null;if(null===e[0])return null;if(!(0,r.k)(e[0]))throw new Error("Invalid Parameter");let m=i._layer;return m instanceof B.default&&(m=(0,O.constructFeatureSet)(m,s.spatialReference,["*"],!0,s.lrucache,s.interceptor)),null===m||!1===(0,r.q)(m)?null:m.load().then(()=>{const o=m.serviceUrl();return(0,O.constructAssociationMetaDataFeatureSetFromUrl)(o,s.spatialReference)}).then(o=>{let l=null,a=null,f=!1;if(null!==u&&""!==u&&void 0!==u){for(const g of o.terminals)g.terminalName===u&&(a=g.terminalId);null===a&&(f=!0)}const d=o.associations.getFieldsIndex(),I=d.get("TOGLOBALID").name,C=d.get("FROMGLOBALID").name,N=d.get("TOTERMINALID").name,L=d.get("FROMTERMINALID").name,v=d.get("FROMNETWORKSOURCEID").name,b=d.get("TONETWORKSOURCEID").name,T=d.get("ASSOCIATIONTYPE").name,de=d.get("ISCONTENTVISIBLE").name,me=d.get("OBJECTID").name;for(const g of m.fields)if("global-id"===g.type){l=i.field(g.name);break}let M=null,k=new h.yN(new S.Z({name:"percentalong",alias:"percentalong",type:"double"}),_.WhereClause.create("0",o.associations.getFieldsIndex())),Q=new h.yN(new S.Z({name:"side",alias:"side",type:"string"}),_.WhereClause.create("''",o.associations.getFieldsIndex()));const P="globalid",Y="globalId",q={};for(const g in o.lkp)q[g]=o.lkp[g].sourceId;const x=new h.TO(new S.Z({name:"classname",alias:"classname",type:"string"}),null,q);let E="";switch(n){case"midspan":{E=`((${I}='${l}') OR ( ${C}='${l}')) AND (${T} IN (5))`,x.codefield=_.WhereClause.create(`CASE WHEN (${I}='${l}') THEN ${v} ELSE ${b} END`,o.associations.getFieldsIndex());const g=(0,R.JW)(h.Xx.findField(o.associations.fields,C));g.name=P,g.alias=P,M=new h.yN(g,_.WhereClause.create(`CASE WHEN (${C}='${l}') THEN ${I} ELSE ${C} END`,o.associations.getFieldsIndex())),k=o.unVersion>=4?new h.$X(h.Xx.findField(o.associations.fields,d.get("PERCENTALONG").name)):new h.yN(new S.Z({name:"percentalong",alias:"percentalong",type:"double"}),_.WhereClause.create("0",o.associations.getFieldsIndex()));break}case"junctionedge":{E=`((${I}='${l}') OR ( ${C}='${l}')) AND (${T} IN (4,6))`,x.codefield=_.WhereClause.create(`CASE WHEN (${I}='${l}') THEN ${v} ELSE ${b} END`,o.associations.getFieldsIndex());const g=(0,R.JW)(h.Xx.findField(o.associations.fields,C));g.name=P,g.alias=P,M=new h.yN(g,_.WhereClause.create(`CASE WHEN (${C}='${l}') THEN ${I} ELSE ${C} END`,o.associations.getFieldsIndex())),Q=new h.yN(new S.Z({name:"side",alias:"side",type:"string"}),_.WhereClause.create(`CASE WHEN (${T}=4) THEN 'from' ELSE 'to' END`,o.associations.getFieldsIndex()));break}case"connected":{let g=`${I}='@T'`,V=`${C}='@T'`;null!==a&&(g+=` AND ${N}=@A`,V+=` AND ${L}=@A`),E="(("+g+") OR ("+V+"))",E=(0,r.M)(E,"@T",l),g=(0,r.M)(g,"@T",l),null!==a&&(g=(0,r.M)(g,"@A",a.toString()),E=(0,r.M)(E,"@A",a.toString())),x.codefield=_.WhereClause.create("CASE WHEN "+g+` THEN ${v} ELSE ${b} END`,o.associations.getFieldsIndex());const Z=(0,R.JW)(h.Xx.findField(o.associations.fields,C));Z.name=P,Z.alias=P,M=new h.yN(Z,_.WhereClause.create("CASE WHEN "+g+` THEN ${C} ELSE ${I} END`,o.associations.getFieldsIndex()));break}case"container":E=`${I}='${l}' AND ${T} = 2`,null!==a&&(E+=` AND ${N} = `+a.toString()),x.codefield=v,E="( "+E+" )",M=new h.QP(h.Xx.findField(o.associations.fields,C),P,P);case"content":E=`(${C}='${l}' AND ${T} = 2)`,null!==a&&(E+=` AND ${L} = `+a.toString()),x.codefield=b,E="( "+E+" )",M=new h.QP(h.Xx.findField(o.associations.fields,I),P,P);break;case"structure":E=`(${I}='${l}' AND ${T} = 3)`,null!==a&&(E+=` AND ${N} = `+a.toString()),x.codefield=v,E="( "+E+" )",M=new h.QP(h.Xx.findField(o.associations.fields,C),P,Y);break;case"attached":E=`(${C}='${l}' AND ${T} = 3)`,null!==a&&(E+=` AND ${L} = `+a.toString()),x.codefield=b,E="( "+E+" )",M=new h.QP(h.Xx.findField(o.associations.fields,I),P,Y);break;default:throw new Error("Invalid Parameter")}return f&&(E="1 <> 1"),new h.Xx({parentfeatureset:o.associations,adaptedFields:[new h.$X(h.Xx.findField(o.associations.fields,me)),new h.$X(h.Xx.findField(o.associations.fields,de)),M,Q,x,k],extraFilter:E?_.WhereClause.create(E,o.associations.getFieldsIndex()):null})})})},t.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),t.functions.groupby=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>((0,r.p)(e,3,3),(0,r.q)(e[0])?e[0].load().then(i=>{const n=[],u=[];let m=!1,o=[];if((0,r.f)(e[1]))o.push(e[1]);else if(e[1]instanceof w.Z)o.push(e[1]);else if((0,r.a)(e[1]))o=e[1];else{if(!(0,r.b)(e[1]))return t.failDefferred("Illegal Value: GroupBy");o=e[1].toArray()}for(const a of o)if((0,r.f)(a)){const f=_.WhereClause.create((0,r.d)(a),i.getFieldsIndex()),d=!0===(0,H.y5)(f)?(0,r.d)(a):"%%%%FIELDNAME";n.push({name:d,expression:f}),"%%%%FIELDNAME"===d&&(m=!0)}else{if(!(a instanceof w.Z))return t.failDefferred("Illegal Value: GroupBy");{const f=a.hasField("name")?a.field("name"):"%%%%FIELDNAME",d=a.hasField("expression")?a.field("expression"):"";if("%%%%FIELDNAME"===f&&(m=!0),!f)return t.failDefferred("Illegal Value: GroupBy");n.push({name:f,expression:_.WhereClause.create(d||f,i.getFieldsIndex())})}}if(o=[],(0,r.f)(e[2]))o.push(e[2]);else if((0,r.a)(e[2]))o=e[2];else if((0,r.b)(e[2]))o=e[2].toArray();else{if(!(e[2]instanceof w.Z))return t.failDefferred("Illegal Value: GroupBy");o.push(e[2])}for(const a of o){if(!(a instanceof w.Z))return t.failDefferred("Illegal Value: GroupBy");{const f=a.hasField("name")?a.field("name"):"",d=a.hasField("statistic")?a.field("statistic"):"",I=a.hasField("expression")?a.field("expression"):"";if(!f||!d||!I)return t.failDefferred("Illegal Value: GroupBy");u.push({name:f,statistic:d.toLowerCase(),expression:_.WhereClause.create(I,i.getFieldsIndex())})}}if(m){const a={};for(const d of i.fields)a[d.name.toLowerCase()]=1;for(const d of n)"%%%%FIELDNAME"!==d.name&&(a[d.name.toLowerCase()]=1);for(const d of u)"%%%%FIELDNAME"!==d.name&&(a[d.name.toLowerCase()]=1);let f=0;for(const d of n)if("%%%%FIELDNAME"===d.name){for(;1===a["field_"+f.toString()];)f++;a["field_"+f.toString()]=1,d.name="FIELD_"+f.toString()}}const l=[];for(const a of n)l.push(j(a.expression,t,s));for(const a of u)l.push(j(a.expression,t,s));return l.length>0?(0,A.$6)(l).then(()=>(0,A.DB)(e[0].groupby(n,u))):(0,A.DB)(e[0].groupby(n,u))}):t.failDefferred("Illegal Value: GroupBy")))},t.signatures.push({name:"groupby",min:"3",max:"3"}),t.functions.distinct=function(s,p){return t.standardFunctionAsync(s,p,(y,F,e)=>(0,r.q)(e[0])?((0,r.p)(e,2,2),e[0].load().then(i=>{const n=[];let u=[];if((0,r.f)(e[1]))u.push(e[1]);else if(e[1]instanceof w.Z)u.push(e[1]);else if((0,r.a)(e[1]))u=e[1];else{if(!(0,r.b)(e[1]))return t.failDefferred("Illegal Value: GroupBy");u=e[1].toArray()}let m=!1;for(const l of u)if((0,r.f)(l)){const a=_.WhereClause.create((0,r.d)(l),i.getFieldsIndex()),f=!0===(0,H.y5)(a)?(0,r.d)(l):"%%%%FIELDNAME";n.push({name:f,expression:a}),"%%%%FIELDNAME"===f&&(m=!0)}else{if(!(l instanceof w.Z))return t.failDefferred("Illegal Value: GroupBy");{const a=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",f=l.hasField("expression")?l.field("expression"):"";if("%%%%FIELDNAME"===a&&(m=!0),!a)return t.failDefferred("Illegal Value: GroupBy");n.push({name:a,expression:_.WhereClause.create(f||a,i.getFieldsIndex())})}}if(m){const l={};for(const f of i.fields)l[f.name.toLowerCase()]=1;for(const f of n)"%%%%FIELDNAME"!==f.name&&(l[f.name.toLowerCase()]=1);let a=0;for(const f of n)if("%%%%FIELDNAME"===f.name){for(;1===l["field_"+a.toString()];)a++;l["field_"+a.toString()]=1,f.name="FIELD_"+a.toString()}}const o=[];for(const l of n)o.push(j(l.expression,t,s));return o.length>0?(0,A.$6)(o).then(()=>(0,A.DB)(e[0].groupby(n,[]))):(0,A.DB)(e[0].groupby(n,[]))})):function oe(t,s,p,y){if(1===y.length){if((0,r.a)(y[0]))return(0,W.t)(t,y[0],-1);if((0,r.b)(y[0]))return(0,W.t)(t,y[0].toArray(),-1)}return(0,W.t)(t,y,-1)}("distinct",0,0,e))})}}}]);