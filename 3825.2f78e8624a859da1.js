"use strict";(self.webpackChunkesri4_pwa=self.webpackChunkesri4_pwa||[]).push([[3825],{53825:(ce,S,r)=>{r.r(S),r.d(S,{default:()=>de});var w=r(15861),n=r(17626),R=r(88879),D=r(48701),p=r(32917),l=r(77712),P=(r(85931),r(8314),r(90912),r(76898)),A=r(51815),j=r(3727),M=r(37384),O=r(97291),L=r(13305),Z=r(14517),B=r(63290),v=r(62208),E=r(10699),G=r(77692),H=r(91757),N=r(1011),W=r(14403),$=r(67802);const J=B.Z.getLogger("esri.views.2d.layers.imagery.ImageryView2D");let d=class extends Z.Z{constructor(){super(...arguments),this.attached=!1,this.container=new N.W,this.updateRequested=!1,this.type="imagery",this._bitmapView=new H.c}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(t=>{(0,E.D_)(t)||J.error(t)})}hitTest(e){return new R.Z({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView),this.strategy=new $.Z({container:this._bitmapView,imageNormalizationSupported:this.layer.version>=10,imageMaxHeight:this.layer.version>=10.1?this.layer.imageMaxHeight:2048,imageMaxWidth:this.layer.version>=10.1?this.layer.imageMaxWidth:2048,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(e=>{e.source instanceof HTMLImageElement?e.requestRender():this.layer.applyRenderer({pixelBlock:e.source.pixelBlock}).then(t=>{const i=e.source;i.pixelBlock=t.pixelBlock,i.filter=s=>this.layer.applyFilter(s),this.container.requestRender()})})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const e=this.strategy.bitmaps;if(1===e.length&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){const t=this.view.extent,i=e.map(a=>a.source).filter(a=>a.extent&&a.extent.intersects(t)).map(a=>({extent:a.extent,pixelBlock:a.originalPixelBlock})),s=(0,G.Kh)(i,t);return(0,v.pC)(s)?{extent:s.extent,pixelBlock:s.pixelBlock}:null}return null}_fetchImage(e,t,i,s){return(s=s||{}).timeExtent=this.timeExtent,s.requestAsImageElement=!0,this.layer.fetchImage(e,t,i,s).then(a=>a.imageElement?a.imageElement:this.layer.applyRenderer(a.pixelData,{signal:s.signal}).then(o=>{const h=new W.Z(o.pixelBlock,o.extent.clone(),a.pixelData.pixelBlock);return h.filter=c=>this.layer.applyFilter(c),h}))}};(0,n._)([(0,l.Cb)()],d.prototype,"attached",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"container",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"layer",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"strategy",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"timeExtent",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"updateRequested",void 0),(0,n._)([(0,l.Cb)()],d.prototype,"updating",null),(0,n._)([(0,l.Cb)()],d.prototype,"type",void 0),d=(0,n._)([(0,P.j)("esri.views.2d.layers.imagery.ImageryView2D")],d);const Y=d;var X=r(84792),K=r(80542),F=r(2004),Q=r(28594),T=r(80355),k=r(15765),I=r(39406),q=r(44589);class _ extends q.Z{constructor(){super(...arguments),this.symbolTypes=["triangle"]}get requiresDedicatedFBO(){return!1}prepareRenderPasses(t){const i=t.registerRenderPass({name:"imagery (vf)",brushes:[k.Z],target:()=>this.children,drawPhase:I.jx.MAP});return[...super.prepareRenderPasses(t),i]}doRender(t){this.visible&&t.drawPhase===I.jx.MAP&&this.symbolTypes.forEach(i=>{t.renderPass=i,super.doRender(t)})}}var ee=r(4102);const te=B.Z.getLogger("esri.views.2d.layers.imagery.VectorFieldView2D");let x=class extends Z.Z{constructor(e){super(e),this.update=(0,E.Ds)((t,i)=>this._update(t,i).catch(s=>{(0,E.D_)(s)||te.error(s)}))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;const t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes="wind_speed"===e.style?["scalar","triangle"]:"simple_scalar"===e.style?["scalar"]:["triangle"],this.container.requestRender()}_update(e,t,i){var s=this;return(0,w.Z)(function*(){if(!e.stationary)return;const{extent:a,spatialReference:o}=e.state,h=new F.Z({xmin:a.xmin,ymin:a.ymin,xmax:a.xmax,ymax:a.ymax,spatialReference:o}),[c,u]=e.state.size;s._loading=s.fetchPixels(h,c,u,i);const m=yield s._loading;s._addToDisplay(m,t,e.state),s._loading=null})()}_addToDisplay(e,t,i){if((0,v.Wi)(e.pixelBlock))return this.container.children.forEach(h=>h.destroy()),void this.container.removeAllChildren();const{extent:s,pixelBlock:a}=e,o=new ee.F(a);o.offset=[0,0],o.symbolizerParameters=t,o.rawPixelData=e,o.invalidateVAO(),o.x=s.xmin,o.y=s.ymax,o.pixelRatio=i.pixelRatio,o.rotation=i.rotation,o.resolution=i.resolution,o.width=a.width*t.symbolTileSize,o.height=a.height*t.symbolTileSize,this.container.children.forEach(h=>h.destroy()),this.container.removeAllChildren(),this.container.symbolTypes="wind_speed"===t.style?["scalar","triangle"]:"simple_scalar"===t.style?["scalar"]:["triangle"],this.container.addChild(o)}};(0,n._)([(0,l.Cb)()],x.prototype,"fetchPixels",void 0),(0,n._)([(0,l.Cb)()],x.prototype,"container",void 0),(0,n._)([(0,l.Cb)()],x.prototype,"_loading",void 0),(0,n._)([(0,l.Cb)()],x.prototype,"updating",null),x=(0,n._)([(0,P.j)("esri.views.2d.layers.imagery.ImageryVFStrategy")],x);const ie=x;let y=class extends K.r{constructor(){var e;super(...arguments),e=this,this.attached=!1,this.container=new _,this.type="imageryVF",this._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""},this._fetchpixels=function(){var t=(0,w.Z)(function*(i,s,a,o){const h=yield e._projectFullExtentPromise,{symbolTileSize:c}=e.layer.renderer,{extent:u,width:m,height:b}=(0,T.BH)(i,s,a,c,h);if((0,v.pC)(h)&&!h.intersects(i))return{extent:u,pixelBlock:null};const C={bbox:`${u.xmin}, ${u.ymin}, ${u.xmax}, ${u.ymax}`,exportParametersVersion:e.layer.exportImageServiceParameters.version,symbolTileSize:c,time:JSON.stringify(e.timeExtent||"")};if(e._canReuseVectorFieldData(C)){const g=e.getPixelData();if((0,v.pC)(g)&&`${g.extent.xmin}, ${g.extent.ymin}, ${g.extent.xmax}, ${g.extent.ymax}`===C.bbox)return g}const{pixelData:V}=yield e.layer.fetchImage(u,m,b,{timeExtent:e.timeExtent,requestAsImageElement:!1,signal:o});return e._dataParameters=C,(0,v.Wi)(V.pixelBlock)?{extent:u,pixelBlock:null}:{extent:u,pixelBlock:"vector-uv"===e.layer.rasterInfo.dataType?(0,v.Wg)((0,T.KC)(V.pixelBlock,"vector-uv")):V.pixelBlock}});return function(i,s,a,o){return t.apply(this,arguments)}}()}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new ie({container:this.container,fetchPixels:this._fetchpixels}),this.handles.add((0,p.YP)(()=>this.layer.renderer,e=>this._updateSymbolizerParams(e),p.tX),"vector-field-view-update")}detach(){this._strategy.destroy(),this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.handles.remove("vector-field-view-update"),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){if(this.updating||!this.container.children.length)return null;const{extent:e,pixelBlock:t}=this.container.children[0].rawPixelData;return{extent:e,pixelBlock:t}}hitTest(e){return new R.Z({attributes:{},geometry:e.clone(),layer:this.layer})}update(e){this._strategy.update(e,this._symbolizerParams)}redraw(){this._updateSymbolizerParams(this.layer.renderer),this._strategy.redraw(this._symbolizerParams)}_canReuseVectorFieldData(e){return this._dataParameters.exportParametersVersion===e.exportParametersVersion&&this._dataParameters.time===e.time&&this._dataParameters.symbolTileSize===e.symbolTileSize&&this._dataParameters.bbox===e.bbox}_getProjectedFullExtent(e){var t=this;return(0,w.Z)(function*(){try{return yield(0,Q.tB)(t.layer.fullExtent,e)}catch(i){try{const s=(yield(0,X.default)(t.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return s?F.Z.fromJSON(s):null}catch(s){return null}}})()}_updateSymbolizerParams(e){"vector-field"===e.type&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};(0,n._)([(0,l.Cb)()],y.prototype,"attached",void 0),(0,n._)([(0,l.Cb)()],y.prototype,"container",void 0),(0,n._)([(0,l.Cb)()],y.prototype,"layer",void 0),(0,n._)([(0,l.Cb)()],y.prototype,"timeExtent",void 0),(0,n._)([(0,l.Cb)()],y.prototype,"type",void 0),(0,n._)([(0,l.Cb)()],y.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],y.prototype,"updating",null),y=(0,n._)([(0,P.j)("esri.views.2d.layers.imagery.VectorFieldView2D")],y);const re=y;var U=r(26584),z=r(49672),se=r(13812),ae=r(84952),ne=r(10023);const le=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}fetchPopupFeatures(i,s){var a=this;return(0,w.Z)(function*(){const{layer:o}=a;if(!i)throw new U.Z("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:o});const{popupEnabled:h}=o,c=(0,ne.V)(o,s);if(!h||!(0,v.pC)(c))throw new U.Z("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:h,popupTemplate:c});const u=yield c.getRequiredFields(),m=new ae.Z;m.timeExtent=a.timeExtent,m.geometry=i,m.outFields=u,m.outSpatialReference=i.spatialReference;const b=a.view.resolution,C="2d"===a.view.type?new z.Z(b,b,a.view.spatialReference):new z.Z(.5*b,.5*b,a.view.spatialReference),{returnTopmostRaster:V,showNoDataRecords:g}=c.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},ue={returnDomainValues:!0,returnTopmostRaster:V,pixelSize:C,showNoDataRecords:g,signal:(0,v.pC)(s)?s.signal:null};return o.queryVisibleRasters(m,ue).then(pe=>pe)})()}canResume(){var i;return!(!super.canResume()||null!=(i=this.timeExtent)&&i.isEmpty)}};return(0,n._)([(0,l.Cb)()],t.prototype,"layer",void 0),(0,n._)([(0,l.Cb)()],t.prototype,"suspended",void 0),(0,n._)([(0,l.Cb)(se.qG)],t.prototype,"timeExtent",void 0),(0,n._)([(0,l.Cb)()],t.prototype,"view",void 0),t=(0,n._)([(0,P.j)("esri.views.layers.ImageryLayerView")],t),t};var oe=r(45611),he=r(94421);let f=class extends(le((0,he.y)((0,M.y)(oe.Z)))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new A.J,this.subview=null}get pixelData(){return this.updating?null:"getPixelData"in this.subview?this.subview.getPixelData():null}get updating(){return!!(!this.subview||"updating"in this.subview&&this.subview.updating)}hitTest(e,t){var i=this;return(0,w.Z)(function*(){return i.subview?[i.subview.hitTest(e)]:null})()}update(e){var t;null==(t=this.subview)||t.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new O.Z({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new L.Z(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.handles.add([(0,p.YP)(()=>{var e;return null!=(e=this.layer.blendMode)?e:"normal"},e=>this.subview.container.blendMode=e,p.tX),(0,p.YP)(()=>{var e;return null!=(e=this.layer.effect)?e:null},e=>this.subview.container.effect=e,p.tX),(0,p.YP)(()=>this.layer.exportImageServiceParameters.version,e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())},p.Z_),(0,p.YP)(()=>this.timeExtent,e=>{this.subview.timeExtent=e,"redraw"in this.subview?this.requestUpdate():this.subview.redrawOrRefetch()},p.Z_),this.layer.on("redraw",()=>{"redraw"in this.subview?this.subview.redraw():this.subview.redrawOrRefetch()}),(0,p.YP)(()=>this.layer.renderer,()=>this._setSubView())],"imagerylayerview-update")}detach(){var e,t;this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),null==(e=this.subview)||e.destroy(),this.handles.remove("imagerylayerview-update"),this.subview=null,null==(t=this._highlightView)||t.destroy(),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,t){if(!((Array.isArray(e)?e[0]:D.Z.isCollection(e)?e.getItemAt(0):e)instanceof R.Z))return{remove:()=>{}};let i=[];return Array.isArray(e)||D.Z.isCollection(e)?i=e.map(s=>s.clone()):e instanceof R.Z&&(i=[e.clone()]),this._highlightGraphics.addMany(i),{remove:()=>{this._highlightGraphics.removeMany(i)}}}doRefresh(){var e=this;return(0,w.Z)(function*(){e.requestUpdate()})()}isUpdating(){return!this.subview||this.subview.updating}_setSubView(){var e;if(!this.view)return;const t=null==(e=this.layer.renderer)?void 0:e.type;let i="imagery";if("vector-field"===t&&"lerc"===this.layer.format?i="imageryVF":"flow"===t&&(i="flow"),this.subview){var s;if(this.subview.type===i)return this._attachSubview(this.subview),void("flow"===this.subview.type&&this.subview.redrawOrRefetch());this._detachSubview(this.subview),null==(s=this.subview)||s.destroy()}this.subview="imagery"===i?new Y({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):"imageryVF"===i?new re({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new j.Z({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0),e.container.blendMode=this.layer.blendMode,e.container.effect=this.layer.effect)}_detachSubview(e){null!=e&&e.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}};(0,n._)([(0,l.Cb)()],f.prototype,"pixelData",null),(0,n._)([(0,l.Cb)({readOnly:!0})],f.prototype,"updating",null),(0,n._)([(0,l.Cb)()],f.prototype,"subview",void 0),f=(0,n._)([(0,P.j)("esri.views.2d.layers.ImageryLayerView2D")],f);const de=f}}]);